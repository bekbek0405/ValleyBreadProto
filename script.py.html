<html>
<head>
<title>script.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
script.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">streamlit </span><span class="s0">as </span><span class="s1">st</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">import </span><span class="s1">plotly</span><span class="s2">.</span><span class="s1">express </span><span class="s0">as </span><span class="s1">px</span>
<span class="s0">import </span><span class="s1">plotly</span><span class="s2">.</span><span class="s1">graph_objects </span><span class="s0">as </span><span class="s1">go</span>
<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">calendar</span>
<span class="s0">from </span><span class="s1">mlxtend</span><span class="s2">.</span><span class="s1">preprocessing </span><span class="s0">import </span><span class="s1">TransactionEncoder</span>
<span class="s0">from </span><span class="s1">mlxtend</span><span class="s2">.</span><span class="s1">frequent_patterns </span><span class="s0">import </span><span class="s1">fpgrowth</span><span class="s2">, </span><span class="s1">association_rules</span>
<span class="s0">import </span><span class="s1">gspread</span>
<span class="s0">from </span><span class="s1">oauth2client</span><span class="s2">.</span><span class="s1">service_account </span><span class="s0">import </span><span class="s1">ServiceAccountCredentials</span>
<span class="s0">from </span><span class="s1">datetime </span><span class="s0">import </span><span class="s1">datetime</span>
<span class="s0">from </span><span class="s1">statsmodels</span><span class="s2">.</span><span class="s1">tsa</span><span class="s2">.</span><span class="s1">seasonal </span><span class="s0">import </span><span class="s1">seasonal_decompose</span>
<span class="s0">from </span><span class="s1">itertools </span><span class="s0">import </span><span class="s1">combinations</span>
<span class="s0">from </span><span class="s1">pmdarima </span><span class="s0">import </span><span class="s1">auto_arima</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics </span><span class="s0">import </span><span class="s1">mean_absolute_error</span><span class="s2">, </span><span class="s1">mean_squared_error</span>
<span class="s0">from </span><span class="s1">statsmodels</span><span class="s2">.</span><span class="s1">tsa</span><span class="s2">.</span><span class="s1">arima</span><span class="s2">.</span><span class="s1">model </span><span class="s0">import </span><span class="s1">ARIMA</span>

<span class="s3"># Ignore warnings</span>
<span class="s1">warnings</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore&quot;</span><span class="s2">)</span>

<span class="s3"># Custom CSS for Full-Width Layout</span>
<span class="s1">st</span><span class="s2">.</span><span class="s1">set_page_config</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;wide&quot;</span><span class="s2">)</span>
<span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;&quot;&quot;  
    &lt;style&gt;  
    .main {  
        background-color: #f7f7f7;  
    }  
    .stButton&gt;button {  
        background-color: #FF6F61;  
        color: white;  
        border-radius: 10px;  
        font-size: 16px;  
    }  
    .big-title {  
        font-size: 36px;  
        font-weight: bold;  
        text-align: center;  
        color: #FF6F61;  
    }  
    .metric-box {  
        background-color: white;  
        padding: 15px;  
        border-radius: 10px;  
        text-align: center;  
    }  
    .explanation {  
        background-color: white;  
        padding: 15px;  
        border-radius: 10px;  
        margin-top: 10px;  
        border-left: 4px solid #FF6F61;  
    }  
    .insight-box {  
        background-color: #000000;  
        color: white !important;  
        padding: 15px;  
        border-radius: 10px;  
        margin-top: 10px;  
        border: 1px solid #FF6F61;  
    } 
    .stDataFrame {  
        border: 1px solid #FF6F61; 
        border-radius: 10px; 
    } 
    &lt;/style&gt;  
&quot;&quot;&quot;</span><span class="s2">, </span><span class="s1">unsafe_allow_html</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s3"># Function to load data from Google Sheets</span>
<span class="s0">def </span><span class="s1">load_data_from_google_sheets</span><span class="s2">(</span><span class="s1">url</span><span class="s2">):</span>
    <span class="s1">csv_export_url </span><span class="s2">= </span><span class="s1">url</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot;/edit?usp=sharing&quot;</span><span class="s2">, </span><span class="s4">&quot;/export?format=csv&quot;</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">read_csv</span><span class="s2">(</span><span class="s1">csv_export_url</span><span class="s2">)</span>
    <span class="s1">data</span><span class="s2">[</span><span class="s4">'Date'</span><span class="s2">] = </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[</span><span class="s4">'Date'</span><span class="s2">], </span><span class="s1">dayfirst</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">=</span><span class="s4">'coerce'</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">data</span>


<span class="s0">def </span><span class="s1">connect_to_google_sheets</span><span class="s2">(</span><span class="s1">sheet_name</span><span class="s2">=</span><span class="s4">&quot;Products&quot;</span><span class="s2">):</span>
    <span class="s1">scope </span><span class="s2">= [</span><span class="s4">&quot;https://spreadsheets.google.com/feeds&quot;</span><span class="s2">, </span><span class="s4">&quot;https://www.googleapis.com/auth/drive&quot;</span><span class="s2">]</span>
    <span class="s1">creds </span><span class="s2">= </span><span class="s1">ServiceAccountCredentials</span><span class="s2">.</span><span class="s1">from_json_keyfile_name</span><span class="s2">(</span><span class="s4">&quot;credentials.json&quot;</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">)</span>
    <span class="s1">client </span><span class="s2">= </span><span class="s1">gspread</span><span class="s2">.</span><span class="s1">authorize</span><span class="s2">(</span><span class="s1">creds</span><span class="s2">)</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">sheet </span><span class="s2">= </span><span class="s1">client</span><span class="s2">.</span><span class="s1">open_by_url</span><span class="s2">(</span>
            <span class="s4">&quot;https://docs.google.com/spreadsheets/d/12meeVmoFhLfmyaSucSETKRtfSAarRNKQox_HCF0uGQo/edit?usp=sharing&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">sheet</span><span class="s2">.</span><span class="s1">worksheet</span><span class="s2">(</span><span class="s1">sheet_name</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s4">f&quot;Error connecting to Google Sheets: </span><span class="s0">{</span><span class="s1">e</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
        <span class="s0">return None</span>


<span class="s3"># CRUD Operations Functions</span>
<span class="s0">def </span><span class="s1">create_data</span><span class="s2">(</span><span class="s1">sheet</span><span class="s2">, </span><span class="s1">item_code</span><span class="s2">, </span><span class="s1">item</span><span class="s2">, </span><span class="s1">price</span><span class="s2">):</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">sheet</span><span class="s2">.</span><span class="s1">append_row</span><span class="s2">([</span><span class="s1">item_code</span><span class="s2">, </span><span class="s1">item</span><span class="s2">, </span><span class="s1">price</span><span class="s2">])</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">success</span><span class="s2">(</span><span class="s4">f&quot;‚úÖ Created new product: </span><span class="s0">{</span><span class="s1">item</span><span class="s0">} </span><span class="s4">(Code: </span><span class="s0">{</span><span class="s1">item_code</span><span class="s0">}</span><span class="s4">) at $</span><span class="s0">{</span><span class="s1">price</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s4">f&quot;‚ùå Error adding product: </span><span class="s0">{</span><span class="s1">e</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">update_data</span><span class="s2">(</span><span class="s1">sheet</span><span class="s2">, </span><span class="s1">item</span><span class="s2">, </span><span class="s1">new_price</span><span class="s2">):</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">sheet</span><span class="s2">.</span><span class="s1">get_all_records</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">row </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">start</span><span class="s2">=</span><span class="s5">2</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">row</span><span class="s2">[</span><span class="s4">&quot;Item&quot;</span><span class="s2">] == </span><span class="s1">item</span><span class="s2">:</span>
                <span class="s1">sheet</span><span class="s2">.</span><span class="s1">update_cell</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s1">new_price</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">success</span><span class="s2">(</span><span class="s4">f&quot;‚úÖ Updated </span><span class="s0">{</span><span class="s1">item</span><span class="s0">} </span><span class="s4">price to $</span><span class="s0">{</span><span class="s1">new_price</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
                <span class="s0">return</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s4">f&quot;‚ùå Product </span><span class="s0">{</span><span class="s1">item</span><span class="s0">} </span><span class="s4">not found.&quot;</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s4">f&quot;‚ùå Error updating product: </span><span class="s0">{</span><span class="s1">e</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">delete_data</span><span class="s2">(</span><span class="s1">sheet</span><span class="s2">, </span><span class="s1">item</span><span class="s2">):</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">sheet</span><span class="s2">.</span><span class="s1">get_all_records</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">row </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">start</span><span class="s2">=</span><span class="s5">2</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">row</span><span class="s2">[</span><span class="s4">&quot;Item&quot;</span><span class="s2">] == </span><span class="s1">item</span><span class="s2">:</span>
                <span class="s1">sheet</span><span class="s2">.</span><span class="s1">delete_rows</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">success</span><span class="s2">(</span><span class="s4">f&quot;‚úÖ Deleted product: </span><span class="s0">{</span><span class="s1">item</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
                <span class="s0">return</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s4">f&quot;‚ùå Product </span><span class="s0">{</span><span class="s1">item</span><span class="s0">} </span><span class="s4">not found.&quot;</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s4">f&quot;‚ùå Error deleting product: </span><span class="s0">{</span><span class="s1">e</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">perform_trend_decomposition</span><span class="s2">(</span><span class="s1">time_series</span><span class="s2">, </span><span class="s1">period</span><span class="s2">=</span><span class="s5">7</span><span class="s2">):</span>
    <span class="s1">decomposition </span><span class="s2">= </span><span class="s1">seasonal_decompose</span><span class="s2">(</span><span class="s1">time_series</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s4">'additive'</span><span class="s2">, </span><span class="s1">period</span><span class="s2">=</span><span class="s1">period</span><span class="s2">)</span>

    <span class="s3"># Calculate mean sales for the time series</span>
    <span class="s1">mean_sales </span><span class="s2">= </span><span class="s1">time_series</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">()</span>

    <span class="s3"># Generate insights</span>
    <span class="s1">insights </span><span class="s2">= {</span>
        <span class="s4">'best_day'</span><span class="s2">: </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">time_series</span><span class="s2">.</span><span class="s1">idxmax</span><span class="s2">().</span><span class="s1">strftime</span><span class="s2">(</span><span class="s4">'%A, %Y-%m-%d'</span><span class="s2">)</span><span class="s0">} </span><span class="s4">(</span><span class="s0">{</span><span class="s1">time_series</span><span class="s2">.</span><span class="s1">max</span><span class="s2">()</span><span class="s0">:</span><span class="s4">.0f</span><span class="s0">} </span><span class="s4">units)&quot;</span><span class="s2">,</span>
        <span class="s4">'worst_day'</span><span class="s2">: </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">time_series</span><span class="s2">.</span><span class="s1">idxmin</span><span class="s2">().</span><span class="s1">strftime</span><span class="s2">(</span><span class="s4">'%A, %Y-%m-%d'</span><span class="s2">)</span><span class="s0">} </span><span class="s4">(</span><span class="s0">{</span><span class="s1">time_series</span><span class="s2">.</span><span class="s1">min</span><span class="s2">()</span><span class="s0">:</span><span class="s4">.0f</span><span class="s0">} </span><span class="s4">units)&quot;</span><span class="s2">,</span>
        <span class="s4">'trend_strength'</span><span class="s2">: </span><span class="s1">decomposition</span><span class="s2">.</span><span class="s1">trend</span><span class="s2">.</span><span class="s1">max</span><span class="s2">() - </span><span class="s1">decomposition</span><span class="s2">.</span><span class="s1">trend</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(),</span>
        <span class="s4">'seasonal_impact'</span><span class="s2">: </span><span class="s1">decomposition</span><span class="s2">.</span><span class="s1">seasonal</span><span class="s2">.</span><span class="s1">max</span><span class="s2">() - </span><span class="s1">decomposition</span><span class="s2">.</span><span class="s1">seasonal</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(),</span>
        <span class="s4">'residual_variability'</span><span class="s2">: </span><span class="s1">decomposition</span><span class="s2">.</span><span class="s1">resid</span><span class="s2">.</span><span class="s1">std</span><span class="s2">(),</span>
        <span class="s4">'peak_sales'</span><span class="s2">: [</span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">date</span><span class="s2">.</span><span class="s1">strftime</span><span class="s2">(</span><span class="s4">'%Y-%m-%d'</span><span class="s2">)</span><span class="s0">} </span><span class="s4">(</span><span class="s0">{</span><span class="s1">date</span><span class="s2">.</span><span class="s1">strftime</span><span class="s2">(</span><span class="s4">'%A'</span><span class="s2">)</span><span class="s0">}</span><span class="s4">)&quot; </span><span class="s0">for </span><span class="s1">date </span><span class="s0">in</span>
                       <span class="s1">time_series</span><span class="s2">[</span><span class="s1">time_series </span><span class="s2">&gt; </span><span class="s1">mean_sales</span><span class="s2">].</span><span class="s1">index</span><span class="s2">],</span>
        <span class="s4">'decline_sales'</span><span class="s2">: [</span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">date</span><span class="s2">.</span><span class="s1">strftime</span><span class="s2">(</span><span class="s4">'%Y-%m-%d'</span><span class="s2">)</span><span class="s0">} </span><span class="s4">(</span><span class="s0">{</span><span class="s1">date</span><span class="s2">.</span><span class="s1">strftime</span><span class="s2">(</span><span class="s4">'%A'</span><span class="s2">)</span><span class="s0">}</span><span class="s4">)&quot; </span><span class="s0">for </span><span class="s1">date </span><span class="s0">in</span>
                          <span class="s1">time_series</span><span class="s2">[</span><span class="s1">time_series </span><span class="s2">&lt; </span><span class="s1">mean_sales</span><span class="s2">].</span><span class="s1">index</span><span class="s2">],</span>
        <span class="s4">'yearly_comparison'</span><span class="s2">: {}</span>
    <span class="s2">}</span>

    <span class="s3"># Compare with previous years</span>
    <span class="s0">for </span><span class="s1">year </span><span class="s0">in </span><span class="s1">time_series</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">year</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">():</span>
        <span class="s1">yearly_data </span><span class="s2">= </span><span class="s1">time_series</span><span class="s2">[</span><span class="s1">time_series</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">year </span><span class="s2">== </span><span class="s1">year</span><span class="s2">]</span>
        <span class="s1">yearly_insights </span><span class="s2">= {</span>
            <span class="s4">'best_day'</span><span class="s2">: </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">yearly_data</span><span class="s2">.</span><span class="s1">idxmax</span><span class="s2">().</span><span class="s1">strftime</span><span class="s2">(</span><span class="s4">'%A, %Y-%m-%d'</span><span class="s2">)</span><span class="s0">} </span><span class="s4">(</span><span class="s0">{</span><span class="s1">yearly_data</span><span class="s2">.</span><span class="s1">max</span><span class="s2">()</span><span class="s0">:</span><span class="s4">.0f</span><span class="s0">} </span><span class="s4">units)&quot;</span><span class="s2">,</span>
            <span class="s4">'worst_day'</span><span class="s2">: </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">yearly_data</span><span class="s2">.</span><span class="s1">idxmin</span><span class="s2">().</span><span class="s1">strftime</span><span class="s2">(</span><span class="s4">'%A, %Y-%m-%d'</span><span class="s2">)</span><span class="s0">} </span><span class="s4">(</span><span class="s0">{</span><span class="s1">yearly_data</span><span class="s2">.</span><span class="s1">min</span><span class="s2">()</span><span class="s0">:</span><span class="s4">.0f</span><span class="s0">} </span><span class="s4">units)&quot;</span><span class="s2">,</span>
            <span class="s4">'average_sales'</span><span class="s2">: </span><span class="s1">yearly_data</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(),</span>
            <span class="s4">'total_sales'</span><span class="s2">: </span><span class="s1">yearly_data</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()</span>
        <span class="s2">}</span>
        <span class="s1">insights</span><span class="s2">[</span><span class="s4">'yearly_comparison'</span><span class="s2">][</span><span class="s1">year</span><span class="s2">] = </span><span class="s1">yearly_insights</span>

    <span class="s0">return </span><span class="s1">decomposition</span><span class="s2">, </span><span class="s1">insights</span>


<span class="s0">def </span><span class="s1">calculate_combined_error</span><span class="s2">(</span><span class="s1">data</span><span class="s2">):</span>
    <span class="s1">status_text </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">()</span>
    <span class="s1">status_text</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s4">&quot;Aggregating sales data for all items...&quot;</span><span class="s2">)</span>

    <span class="s3"># Aggregate all sales by date based on QUANTITY</span>
    <span class="s1">date_range </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">date_range</span><span class="s2">(</span><span class="s1">start</span><span class="s2">=</span><span class="s1">data</span><span class="s2">[</span><span class="s4">'Date'</span><span class="s2">].</span><span class="s1">min</span><span class="s2">(), </span><span class="s1">end</span><span class="s2">=</span><span class="s1">data</span><span class="s2">[</span><span class="s4">'Date'</span><span class="s2">].</span><span class="s1">max</span><span class="s2">(), </span><span class="s1">freq</span><span class="s2">=</span><span class="s4">'D'</span><span class="s2">)</span>
    <span class="s1">combined_time_series </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s4">'Date'</span><span class="s2">)[</span><span class="s4">'Quantity'</span><span class="s2">].</span><span class="s1">sum</span><span class="s2">().</span><span class="s1">reindex</span><span class="s2">(</span><span class="s1">date_range</span><span class="s2">, </span><span class="s1">fill_value</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">time_series_smoothed </span><span class="s2">= </span><span class="s1">combined_time_series</span><span class="s2">.</span><span class="s1">rolling</span><span class="s2">(</span><span class="s1">window</span><span class="s2">=</span><span class="s5">7</span><span class="s2">, </span><span class="s1">center</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">min_periods</span><span class="s2">=</span><span class="s5">1</span><span class="s2">).</span><span class="s1">mean</span><span class="s2">()</span>

    <span class="s3"># Train-test split (last 30 days)</span>
    <span class="s1">train_size </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">time_series_smoothed</span><span class="s2">) - </span><span class="s5">30</span>
    <span class="s0">if </span><span class="s1">train_size </span><span class="s2">&lt; </span><span class="s5">30</span><span class="s2">:</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s4">&quot;Insufficient data to perform a reliable test. At least 60 days of data are needed.&quot;</span><span class="s2">)</span>
        <span class="s0">return None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span>

    <span class="s1">train</span><span class="s2">, </span><span class="s1">test </span><span class="s2">= </span><span class="s1">time_series_smoothed</span><span class="s2">[:</span><span class="s1">train_size</span><span class="s2">], </span><span class="s1">time_series_smoothed</span><span class="s2">[</span><span class="s1">train_size</span><span class="s2">:]</span>
    <span class="s1">train_log </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">(</span><span class="s1">train</span><span class="s2">)</span>

    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">status_text</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s4">&quot;Building forecast model...&quot;</span><span class="s2">)</span>
        <span class="s1">model </span><span class="s2">= </span><span class="s1">auto_arima</span><span class="s2">(</span><span class="s1">train_log</span><span class="s2">, </span><span class="s1">seasonal</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">m</span><span class="s2">=</span><span class="s5">7</span><span class="s2">, </span><span class="s1">suppress_warnings</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">error_action</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">, </span><span class="s1">stepwise</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                           <span class="s1">n_jobs</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">)</span>

        <span class="s3"># --- 1. Standard Test ---</span>
        <span class="s1">status_text</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s4">&quot;Performing standard test...&quot;</span><span class="s2">)</span>
        <span class="s1">standard_forecast_log </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">n_periods</span><span class="s2">=</span><span class="s1">len</span><span class="s2">(</span><span class="s1">test</span><span class="s2">))</span>
        <span class="s1">standard_forecast </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(</span><span class="s1">standard_forecast_log</span><span class="s2">)</span>
        <span class="s1">standard_forecast</span><span class="s2">[</span><span class="s1">standard_forecast </span><span class="s2">&lt; </span><span class="s5">0</span><span class="s2">] = </span><span class="s5">0</span>
        <span class="s1">standard_mae </span><span class="s2">= </span><span class="s1">mean_absolute_error</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">standard_forecast</span><span class="s2">)</span>
        <span class="s1">standard_rmse </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">mean_squared_error</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">standard_forecast</span><span class="s2">))</span>

        <span class="s3"># --- 2. Dynamic Test ---</span>
        <span class="s1">status_text</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s4">&quot;Performing dynamic test (this may take a moment)...&quot;</span><span class="s2">)</span>
        <span class="s1">history </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">train_log</span><span class="s2">)</span>
        <span class="s1">dynamic_predictions </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">test</span><span class="s2">)):</span>
            <span class="s1">temp_model </span><span class="s2">= </span><span class="s1">ARIMA</span><span class="s2">(</span><span class="s1">history</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s1">model</span><span class="s2">.</span><span class="s1">order</span><span class="s2">, </span><span class="s1">seasonal_order</span><span class="s2">=</span><span class="s1">model</span><span class="s2">.</span><span class="s1">seasonal_order</span><span class="s2">)</span>
            <span class="s1">model_fit </span><span class="s2">= </span><span class="s1">temp_model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">()</span>
            <span class="s1">output </span><span class="s2">= </span><span class="s1">model_fit</span><span class="s2">.</span><span class="s1">forecast</span><span class="s2">()</span>
            <span class="s1">yhat </span><span class="s2">= </span><span class="s1">output</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
            <span class="s1">dynamic_predictions</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">yhat</span><span class="s2">)</span>
            <span class="s1">history</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s1">t</span><span class="s2">]))  </span><span class="s3"># Add actual observed value</span>

        <span class="s1">dynamic_forecast </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(</span><span class="s1">dynamic_predictions</span><span class="s2">)</span>
        <span class="s1">dynamic_forecast</span><span class="s2">[</span><span class="s1">dynamic_forecast </span><span class="s2">&lt; </span><span class="s5">0</span><span class="s2">] = </span><span class="s5">0</span>
        <span class="s1">dynamic_mae </span><span class="s2">= </span><span class="s1">mean_absolute_error</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">dynamic_forecast</span><span class="s2">)</span>
        <span class="s1">dynamic_rmse </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">mean_squared_error</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">dynamic_forecast</span><span class="s2">))</span>

        <span class="s1">status_text</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">standard_mae</span><span class="s2">, </span><span class="s1">standard_rmse</span><span class="s2">, </span><span class="s1">dynamic_mae</span><span class="s2">, </span><span class="s1">dynamic_rmse</span>

    <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s4">f&quot;An error occurred during model building: </span><span class="s0">{</span><span class="s1">e</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
        <span class="s1">status_text</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">()</span>
        <span class="s0">return None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span>


<span class="s3"># Load Data</span>
<span class="s1">data </span><span class="s2">= </span><span class="s1">load_data_from_google_sheets</span><span class="s2">(</span>
    <span class="s4">&quot;https://docs.google.com/spreadsheets/d/12meeVmoFhLfmyaSucSETKRtfSAarRNKQox_HCF0uGQo/edit?usp=sharing&quot;</span><span class="s2">)</span>
<span class="s1">data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">dropna</span><span class="s2">(</span><span class="s1">subset</span><span class="s2">=[</span><span class="s4">'Date'</span><span class="s2">])</span>

<span class="s3"># Sidebar Configuration</span>
<span class="s1">st</span><span class="s2">.</span><span class="s1">sidebar</span><span class="s2">.</span><span class="s1">title</span><span class="s2">(</span><span class="s4">&quot;üõ† CRUD Operations&quot;</span><span class="s2">)</span>
<span class="s1">action </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">sidebar</span><span class="s2">.</span><span class="s1">selectbox</span><span class="s2">(</span><span class="s4">&quot;Select Action&quot;</span><span class="s2">, [</span><span class="s4">&quot;Create&quot;</span><span class="s2">, </span><span class="s4">&quot;Update&quot;</span><span class="s2">, </span><span class="s4">&quot;Delete&quot;</span><span class="s2">])</span>

<span class="s3"># New sidebar controls for showing/hiding sections</span>
<span class="s1">st</span><span class="s2">.</span><span class="s1">sidebar</span><span class="s2">.</span><span class="s1">header</span><span class="s2">(</span><span class="s4">&quot;üìä Display Options&quot;</span><span class="s2">)</span>
<span class="s1">show_combined_performance </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">sidebar</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">&quot;Show Combined Performance for All Items&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
<span class="s1">show_standard_dynamic_test </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">sidebar</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">&quot;Show Standard &amp; Dynamic Test Results&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

<span class="s3"># CRUD Operations</span>
<span class="s1">sheet </span><span class="s2">= </span><span class="s1">connect_to_google_sheets</span><span class="s2">()</span>
<span class="s0">if </span><span class="s1">action </span><span class="s2">== </span><span class="s4">&quot;Create&quot;</span><span class="s2">:</span>
    <span class="s1">st</span><span class="s2">.</span><span class="s1">sidebar</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;Create New Product&quot;</span><span class="s2">)</span>
    <span class="s1">new_item_code </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">sidebar</span><span class="s2">.</span><span class="s1">text_input</span><span class="s2">(</span><span class="s4">&quot;Item Code&quot;</span><span class="s2">)</span>
    <span class="s1">new_item </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">sidebar</span><span class="s2">.</span><span class="s1">text_input</span><span class="s2">(</span><span class="s4">&quot;Product Name&quot;</span><span class="s2">)</span>
    <span class="s1">new_price </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">sidebar</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span><span class="s4">&quot;Price&quot;</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s5">0.0</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s5">0.0</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">st</span><span class="s2">.</span><span class="s1">sidebar</span><span class="s2">.</span><span class="s1">button</span><span class="s2">(</span><span class="s4">&quot;Create Product&quot;</span><span class="s2">):</span>
        <span class="s1">create_data</span><span class="s2">(</span><span class="s1">sheet</span><span class="s2">, </span><span class="s1">new_item_code</span><span class="s2">, </span><span class="s1">new_item</span><span class="s2">, </span><span class="s1">new_price</span><span class="s2">)</span>

<span class="s0">elif </span><span class="s1">action </span><span class="s2">== </span><span class="s4">&quot;Update&quot;</span><span class="s2">:</span>
    <span class="s1">st</span><span class="s2">.</span><span class="s1">sidebar</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;Update Product&quot;</span><span class="s2">)</span>
    <span class="s1">product_names </span><span class="s2">= [</span><span class="s1">row</span><span class="s2">[</span><span class="s4">&quot;Item&quot;</span><span class="s2">] </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">sheet</span><span class="s2">.</span><span class="s1">get_all_records</span><span class="s2">()]</span>
    <span class="s1">item_to_update </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">sidebar</span><span class="s2">.</span><span class="s1">selectbox</span><span class="s2">(</span><span class="s4">&quot;Select Product to Update&quot;</span><span class="s2">, </span><span class="s1">product_names</span><span class="s2">)</span>
    <span class="s1">new_price </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">sidebar</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span><span class="s4">&quot;New Price&quot;</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s5">0.0</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s5">0.0</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">st</span><span class="s2">.</span><span class="s1">sidebar</span><span class="s2">.</span><span class="s1">button</span><span class="s2">(</span><span class="s4">&quot;Update Product&quot;</span><span class="s2">):</span>
        <span class="s1">update_data</span><span class="s2">(</span><span class="s1">sheet</span><span class="s2">, </span><span class="s1">item_to_update</span><span class="s2">, </span><span class="s1">new_price</span><span class="s2">)</span>

<span class="s0">elif </span><span class="s1">action </span><span class="s2">== </span><span class="s4">&quot;Delete&quot;</span><span class="s2">:</span>
    <span class="s1">st</span><span class="s2">.</span><span class="s1">sidebar</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;Delete Product&quot;</span><span class="s2">)</span>
    <span class="s1">product_names </span><span class="s2">= [</span><span class="s1">row</span><span class="s2">[</span><span class="s4">&quot;Item&quot;</span><span class="s2">] </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">sheet</span><span class="s2">.</span><span class="s1">get_all_records</span><span class="s2">()]</span>
    <span class="s1">item_to_delete </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">sidebar</span><span class="s2">.</span><span class="s1">selectbox</span><span class="s2">(</span><span class="s4">&quot;Select Product to Delete&quot;</span><span class="s2">, </span><span class="s1">product_names</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">st</span><span class="s2">.</span><span class="s1">sidebar</span><span class="s2">.</span><span class="s1">button</span><span class="s2">(</span><span class="s4">&quot;Delete Product&quot;</span><span class="s2">):</span>
        <span class="s1">delete_data</span><span class="s2">(</span><span class="s1">sheet</span><span class="s2">, </span><span class="s1">item_to_delete</span><span class="s2">)</span>

<span class="s3"># Main Dashboard</span>
<span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">'&lt;p class=&quot;big-title&quot;&gt;üçû Bakery Sales Dashboard&lt;/p&gt;'</span><span class="s2">, </span><span class="s1">unsafe_allow_html</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;### Track sales, forecast trends, and optimize product demand!&quot;</span><span class="s2">)</span>

<span class="s3"># Sidebar Controls</span>
<span class="s1">st</span><span class="s2">.</span><span class="s1">sidebar</span><span class="s2">.</span><span class="s1">header</span><span class="s2">(</span><span class="s4">&quot;üîç Analysis Controls&quot;</span><span class="s2">)</span>
<span class="s1">products </span><span class="s2">= [</span><span class="s4">&quot;Choose Product&quot;</span><span class="s2">] + </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[</span><span class="s4">'Item'</span><span class="s2">].</span><span class="s1">unique</span><span class="s2">())</span>
<span class="s1">selected_product </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">sidebar</span><span class="s2">.</span><span class="s1">selectbox</span><span class="s2">(</span><span class="s4">&quot;Select Product&quot;</span><span class="s2">, </span><span class="s1">products</span><span class="s2">)</span>

<span class="s1">min_date </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s4">'Date'</span><span class="s2">].</span><span class="s1">min</span><span class="s2">()</span>
<span class="s1">max_date </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s4">'Date'</span><span class="s2">].</span><span class="s1">max</span><span class="s2">()</span>

<span class="s3"># Create tabs</span>
<span class="s1">tab1</span><span class="s2">, </span><span class="s1">tab2 </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">tabs</span><span class="s2">([</span><span class="s4">&quot;üìä Sales &amp; Forecasting&quot;</span><span class="s2">, </span><span class="s4">&quot;üîó Product Associations&quot;</span><span class="s2">])</span>

<span class="s3"># Tab 1: Sales &amp; Forecasting</span>
<span class="s0">with </span><span class="s1">tab1</span><span class="s2">:</span>
    <span class="s1">st</span><span class="s2">.</span><span class="s1">header</span><span class="s2">(</span><span class="s4">&quot;üìä Business Metrics&quot;</span><span class="s2">)</span>
    <span class="s1">col1</span><span class="s2">, </span><span class="s1">col2</span><span class="s2">, </span><span class="s1">col3 </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">col1</span><span class="s2">.</span><span class="s1">metric</span><span class="s2">(</span><span class="s4">&quot;Total Products Sold&quot;</span><span class="s2">, </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">data</span><span class="s2">[</span><span class="s4">'Quantity'</span><span class="s2">].</span><span class="s1">sum</span><span class="s2">()</span><span class="s0">:</span><span class="s4">,</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
    <span class="s1">col2</span><span class="s2">.</span><span class="s1">metric</span><span class="s2">(</span><span class="s4">&quot;Unique Products&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">[</span><span class="s4">'Item'</span><span class="s2">].</span><span class="s1">nunique</span><span class="s2">())</span>
    <span class="s1">col3</span><span class="s2">.</span><span class="s1">metric</span><span class="s2">(</span><span class="s4">&quot;Total Transactions&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">[</span><span class="s4">'ticket_number'</span><span class="s2">].</span><span class="s1">nunique</span><span class="s2">())</span>

    <span class="s1">st</span><span class="s2">.</span><span class="s1">header</span><span class="s2">(</span><span class="s4">&quot;üèÜ Top Performing Products&quot;</span><span class="s2">)</span>
    <span class="s1">top_products </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s4">'Item'</span><span class="s2">)[</span><span class="s4">'Quantity'</span><span class="s2">].</span><span class="s1">sum</span><span class="s2">().</span><span class="s1">nlargest</span><span class="s2">(</span><span class="s5">5</span><span class="s2">).</span><span class="s1">reset_index</span><span class="s2">()</span>

    <span class="s3"># Create horizontal bar chart</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">px</span><span class="s2">.</span><span class="s1">bar</span><span class="s2">(</span><span class="s1">top_products</span><span class="s2">,</span>
                 <span class="s1">x</span><span class="s2">=</span><span class="s4">'Quantity'</span><span class="s2">,</span>
                 <span class="s1">y</span><span class="s2">=</span><span class="s4">'Item'</span><span class="s2">,</span>
                 <span class="s1">color</span><span class="s2">=</span><span class="s4">'Quantity'</span><span class="s2">,</span>
                 <span class="s1">orientation</span><span class="s2">=</span><span class="s4">'h'</span><span class="s2">,</span>
                 <span class="s1">title</span><span class="s2">=</span><span class="s4">&quot;Top 5 Best-Selling Items&quot;</span><span class="s2">,</span>
                 <span class="s1">labels</span><span class="s2">={</span><span class="s4">'Quantity'</span><span class="s2">: </span><span class="s4">'Units Sold'</span><span class="s2">, </span><span class="s4">'Item'</span><span class="s2">: </span><span class="s4">'Product'</span><span class="s2">},</span>
                 <span class="s1">color_continuous_scale</span><span class="s2">=</span><span class="s4">'mint'</span><span class="s2">)</span>

    <span class="s3"># Improve layout</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">update_layout</span><span class="s2">(</span>
        <span class="s1">yaxis</span><span class="s2">={</span><span class="s4">'categoryorder'</span><span class="s2">: </span><span class="s4">'total ascending'</span><span class="s2">},</span>
        <span class="s1">height</span><span class="s2">=</span><span class="s5">400</span><span class="s2">,</span>
        <span class="s1">margin</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">l</span><span class="s2">=</span><span class="s5">120</span><span class="s2">, </span><span class="s1">r</span><span class="s2">=</span><span class="s5">20</span><span class="s2">, </span><span class="s1">t</span><span class="s2">=</span><span class="s5">40</span><span class="s2">, </span><span class="s1">b</span><span class="s2">=</span><span class="s5">20</span><span class="s2">)</span>
    <span class="s2">)</span>

    <span class="s1">st</span><span class="s2">.</span><span class="s1">plotly_chart</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">use_container_width</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s3"># --- SECTION FOR COMBINED MODEL PERFORMANCE (STANDARD &amp; DYNAMIC) ---</span>
    <span class="s0">if </span><span class="s1">show_combined_performance</span><span class="s2">:</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">header</span><span class="s2">(</span><span class="s4">&quot;üìà Combined Performance for All Items (by Quantity)&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">show_standard_dynamic_test</span><span class="s2">:</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span>
                <span class="s4">&quot;Calculate forecast accuracy using two methods: a **Standard Test** (forecasts all at once) and a **Dynamic Test** (forecasts day-by-day, updating with new data).&quot;</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">st</span><span class="s2">.</span><span class="s1">button</span><span class="s2">(</span><span class="s4">&quot;Run Standard &amp; Dynamic Tests&quot;</span><span class="s2">):</span>
                <span class="s0">with </span><span class="s1">st</span><span class="s2">.</span><span class="s1">spinner</span><span class="s2">(</span><span class="s4">&quot;Running tests... The dynamic test may take a moment.&quot;</span><span class="s2">):</span>
                    <span class="s1">s_mae</span><span class="s2">, </span><span class="s1">s_rmse</span><span class="s2">, </span><span class="s1">d_mae</span><span class="s2">, </span><span class="s1">d_rmse </span><span class="s2">= </span><span class="s1">calculate_combined_error</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">s_mae </span><span class="s0">is not None</span><span class="s2">:</span>
                        <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;Forecast Accuracy Metrics (Total Units Sold)&quot;</span><span class="s2">)</span>

                        <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;#### Standard Test Results&quot;</span><span class="s2">)</span>
                        <span class="s1">mcol1</span><span class="s2">, </span><span class="s1">mcol2 </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
                        <span class="s1">mcol1</span><span class="s2">.</span><span class="s1">metric</span><span class="s2">(</span><span class="s1">label</span><span class="s2">=</span><span class="s4">&quot;MAE (Standard)&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">s_mae</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">units&quot;</span><span class="s2">)</span>
                        <span class="s1">mcol2</span><span class="s2">.</span><span class="s1">metric</span><span class="s2">(</span><span class="s1">label</span><span class="s2">=</span><span class="s4">&quot;RMSE (Standard)&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">s_rmse</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">units&quot;</span><span class="s2">)</span>

                        <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;#### Dynamic Test Results&quot;</span><span class="s2">)</span>
                        <span class="s1">mcol3</span><span class="s2">, </span><span class="s1">mcol4 </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
                        <span class="s1">mcol3</span><span class="s2">.</span><span class="s1">metric</span><span class="s2">(</span><span class="s1">label</span><span class="s2">=</span><span class="s4">&quot;MAE (Dynamic)&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">d_mae</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">units&quot;</span><span class="s2">)</span>
                        <span class="s1">mcol4</span><span class="s2">.</span><span class="s1">metric</span><span class="s2">(</span><span class="s1">label</span><span class="s2">=</span><span class="s4">&quot;RMSE (Dynamic)&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">d_rmse</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">units&quot;</span><span class="s2">)</span>

                        <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">f&quot;&quot;&quot;</span>
                            <span class="s4">&lt;div class='insight-box'&gt;</span>
                                <span class="s4">üí° **Accuracy Summary**</span>
                                <span class="s4">&lt;ul&gt;</span>
                                    <span class="s4">&lt;li&gt;The &lt;b&gt;Standard Test&lt;/b&gt; shows the model's performance when predicting the next 30 days with no new information. The average error was &lt;b&gt;</span><span class="s0">{</span><span class="s1">s_mae</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">units&lt;/b&gt; per day.&lt;/li&gt;</span>
                                    <span class="s4">&lt;li&gt;The &lt;b&gt;Dynamic Test&lt;/b&gt; simulates a real-world scenario by updating the forecast daily with the latest sales data. This resulted in an average error of &lt;b&gt;</span><span class="s0">{</span><span class="s1">d_mae</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">units&lt;/b&gt; per day.&lt;/li&gt;</span>
                                    <span class="s4">&lt;li&gt;A lower dynamic error suggests the model adapts well to new information.&lt;/li&gt;</span>
                                <span class="s4">&lt;/ul&gt;</span>
                            <span class="s4">&lt;/div&gt;</span>
                            <span class="s4">&quot;&quot;&quot;</span><span class="s2">, </span><span class="s1">unsafe_allow_html</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;Standard &amp; Dynamic test results are currently hidden. Enable them in the sidebar to view.&quot;</span><span class="s2">)</span>

    <span class="s3"># Improved SARIMA Forecasting Section</span>
    <span class="s0">if </span><span class="s1">selected_product </span><span class="s2">!= </span><span class="s4">&quot;Choose Product&quot;</span><span class="s2">:</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">header</span><span class="s2">(</span><span class="s4">&quot;üîÆ Advanced Forecasting (Optimized)&quot;</span><span class="s2">)</span>
        <span class="s1">data</span><span class="s2">[</span><span class="s4">'Total Sales'</span><span class="s2">] = </span><span class="s1">data</span><span class="s2">[</span><span class="s4">'Quantity'</span><span class="s2">] * </span><span class="s1">data</span><span class="s2">[</span><span class="s4">'Price'</span><span class="s2">]</span>

        <span class="s3"># Normalize the 'Date' column to ensure consistency</span>
        <span class="s1">data</span><span class="s2">[</span><span class="s4">'Date'</span><span class="s2">] = </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[</span><span class="s4">'Date'</span><span class="s2">]).</span><span class="s1">dt</span><span class="s2">.</span><span class="s1">normalize</span><span class="s2">()</span>

        <span class="s1">filtered_data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s1">data</span><span class="s2">[</span><span class="s4">'Item'</span><span class="s2">] == </span><span class="s1">selected_product</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">()</span>

        <span class="s3"># Group data by date and create the time series</span>
        <span class="s1">time_series_qty </span><span class="s2">= </span><span class="s1">filtered_data</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s4">'Date'</span><span class="s2">)[</span><span class="s4">'Quantity'</span><span class="s2">].</span><span class="s1">sum</span><span class="s2">()</span>
        <span class="s1">time_series_rev </span><span class="s2">= </span><span class="s1">filtered_data</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s4">'Date'</span><span class="s2">)[</span><span class="s4">'Total Sales'</span><span class="s2">].</span><span class="s1">sum</span><span class="s2">()</span>

        <span class="s3"># If a product has very few sales, it cannot be forecasted.</span>
        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">time_series_qty</span><span class="s2">) &lt; </span><span class="s5">40</span><span class="s2">:  </span><span class="s3"># Increased minimum data points for reliability</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span>
                <span class="s4">f&quot;‚ö†Ô∏è Not enough data for '</span><span class="s0">{</span><span class="s1">selected_product</span><span class="s0">}</span><span class="s4">' to generate a reliable forecast. At least 40 sales days are recommended.&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s3"># Apply 7-day rolling mean (centered) for smoothing</span>
            <span class="s1">time_series_qty_smoothed </span><span class="s2">= </span><span class="s1">time_series_qty</span><span class="s2">.</span><span class="s1">rolling</span><span class="s2">(</span><span class="s1">window</span><span class="s2">=</span><span class="s5">7</span><span class="s2">, </span><span class="s1">center</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">min_periods</span><span class="s2">=</span><span class="s5">1</span><span class="s2">).</span><span class="s1">mean</span><span class="s2">()</span>
            <span class="s1">time_series_rev_smoothed </span><span class="s2">= </span><span class="s1">time_series_rev</span><span class="s2">.</span><span class="s1">rolling</span><span class="s2">(</span><span class="s1">window</span><span class="s2">=</span><span class="s5">7</span><span class="s2">, </span><span class="s1">center</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">min_periods</span><span class="s2">=</span><span class="s5">1</span><span class="s2">).</span><span class="s1">mean</span><span class="s2">()</span>

        <span class="s1">col1</span><span class="s2">, </span><span class="s1">col2 </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">col1</span><span class="s2">:</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;üí∞ Revenue Forecast&quot;</span><span class="s2">)</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s3"># Train-test split (last 30 days as test set)</span>
                <span class="s1">train_size </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">time_series_rev_smoothed</span><span class="s2">) - </span><span class="s5">30</span>
                <span class="s1">train</span><span class="s2">, </span><span class="s1">test </span><span class="s2">= </span><span class="s1">time_series_rev_smoothed</span><span class="s2">[:</span><span class="s1">train_size</span><span class="s2">], </span><span class="s1">time_series_rev_smoothed</span><span class="s2">[</span><span class="s1">train_size</span><span class="s2">:]</span>

                <span class="s3"># Automatic seasonality detection</span>
                <span class="s1">decomposition </span><span class="s2">= </span><span class="s1">seasonal_decompose</span><span class="s2">(</span><span class="s1">train</span><span class="s2">, </span><span class="s1">period</span><span class="s2">=</span><span class="s5">7</span><span class="s2">)</span>
                <span class="s1">seasonal_strength </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">decomposition</span><span class="s2">.</span><span class="s1">seasonal</span><span class="s2">).</span><span class="s1">mean</span><span class="s2">() / </span><span class="s1">decomposition</span><span class="s2">.</span><span class="s1">observed</span><span class="s2">.</span><span class="s1">std</span><span class="s2">()</span>

                <span class="s3"># Determine if seasonal model is needed</span>
                <span class="s1">use_seasonal </span><span class="s2">= </span><span class="s1">seasonal_strength </span><span class="s2">&gt; </span><span class="s5">0.4  </span><span class="s3"># Only use seasonal if strong seasonality</span>

                <span class="s3"># Log transform instead of Box-Cox (more stable for SARIMA)</span>
                <span class="s1">train_log </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">(</span><span class="s1">train</span><span class="s2">)  </span><span class="s3"># log(1+x) to handle zeros</span>

                <span class="s3"># Auto ARIMA with improved configuration</span>
                <span class="s1">model_rev </span><span class="s2">= </span><span class="s1">auto_arima</span><span class="s2">(</span>
                    <span class="s1">train_log</span><span class="s2">,</span>
                    <span class="s1">seasonal</span><span class="s2">=</span><span class="s1">use_seasonal</span><span class="s2">,</span>
                    <span class="s1">m</span><span class="s2">=</span><span class="s5">7 </span><span class="s0">if </span><span class="s1">use_seasonal </span><span class="s0">else </span><span class="s5">1</span><span class="s2">,</span>
                    <span class="s1">start_p</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
                    <span class="s1">start_q</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
                    <span class="s1">max_p</span><span class="s2">=</span><span class="s5">3</span><span class="s2">,</span>
                    <span class="s1">max_q</span><span class="s2">=</span><span class="s5">3</span><span class="s2">,</span>
                    <span class="s1">d</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,  </span><span class="s3"># Force at least one differencing</span>
                    <span class="s1">max_d</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
                    <span class="s1">start_P</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
                    <span class="s1">start_Q</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
                    <span class="s1">max_P</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
                    <span class="s1">max_Q</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
                    <span class="s1">trace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                    <span class="s1">error_action</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">,</span>
                    <span class="s1">suppress_warnings</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                    <span class="s1">stepwise</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                    <span class="s1">information_criterion</span><span class="s2">=</span><span class="s4">'aic'</span><span class="s2">,</span>
                    <span class="s1">n_jobs</span><span class="s2">=-</span><span class="s5">1</span>
                <span class="s2">)</span>

                <span class="s1">st</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s4">f&quot;Optimized SARIMA order: </span><span class="s0">{</span><span class="s1">model_rev</span><span class="s2">.</span><span class="s1">order</span><span class="s0">}</span><span class="s4">, seasonal order: </span><span class="s0">{</span><span class="s1">model_rev</span><span class="s2">.</span><span class="s1">seasonal_order</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>

                <span class="s3"># Forecast on test set</span>
                <span class="s1">test_forecast_log </span><span class="s2">= </span><span class="s1">model_rev</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">n_periods</span><span class="s2">=</span><span class="s1">len</span><span class="s2">(</span><span class="s1">test</span><span class="s2">))</span>
                <span class="s1">test_forecast </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(</span><span class="s1">test_forecast_log</span><span class="s2">)</span>

                <span class="s3"># Calculate evaluation metrics</span>
                <span class="s1">mae </span><span class="s2">= </span><span class="s1">mean_absolute_error</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">test_forecast</span><span class="s2">)</span>
                <span class="s1">rmse </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">mean_squared_error</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">test_forecast</span><span class="s2">))</span>

                <span class="s3"># Dynamic forecasting for better test evaluation</span>
                <span class="s1">history </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">train_log</span><span class="s2">)</span>
                <span class="s1">dynamic_forecast </span><span class="s2">= []</span>
                <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">test</span><span class="s2">)):</span>
                    <span class="s1">model </span><span class="s2">= </span><span class="s1">ARIMA</span><span class="s2">(</span><span class="s1">history</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s1">model_rev</span><span class="s2">.</span><span class="s1">order</span><span class="s2">, </span><span class="s1">seasonal_order</span><span class="s2">=</span><span class="s1">model_rev</span><span class="s2">.</span><span class="s1">seasonal_order</span><span class="s2">)</span>
                    <span class="s1">model_fit </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">()</span>
                    <span class="s1">output </span><span class="s2">= </span><span class="s1">model_fit</span><span class="s2">.</span><span class="s1">forecast</span><span class="s2">()</span>
                    <span class="s1">dynamic_forecast</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">output</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
                    <span class="s1">history</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s1">t</span><span class="s2">]))</span>

                <span class="s1">dynamic_forecast </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(</span><span class="s1">dynamic_forecast</span><span class="s2">)</span>
                <span class="s1">dynamic_mae </span><span class="s2">= </span><span class="s1">mean_absolute_error</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">dynamic_forecast</span><span class="s2">)</span>
                <span class="s1">dynamic_rmse </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">mean_squared_error</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">dynamic_forecast</span><span class="s2">))</span>

                <span class="s0">if </span><span class="s1">show_standard_dynamic_test</span><span class="s2">:</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s4">f&quot;Standard Test Performance: MAE=‚Ç±</span><span class="s0">{</span><span class="s1">mae</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">}</span><span class="s4">, RMSE=‚Ç±</span><span class="s0">{</span><span class="s1">rmse</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s4">f&quot;Dynamic Test Performance: MAE=‚Ç±</span><span class="s0">{</span><span class="s1">dynamic_mae</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">}</span><span class="s4">, RMSE=‚Ç±</span><span class="s0">{</span><span class="s1">dynamic_rmse</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>

                <span class="s3"># Final forecast with confidence intervals</span>
                <span class="s1">forecast_steps </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">slider</span><span class="s2">(</span><span class="s4">&quot;Forecast Days (Revenue)&quot;</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">31</span><span class="s2">, </span><span class="s5">14</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;rev_forecast&quot;</span><span class="s2">)</span>

                <span class="s3"># Refit model on full data</span>
                <span class="s1">full_model </span><span class="s2">= </span><span class="s1">ARIMA</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">(</span><span class="s1">time_series_rev_smoothed</span><span class="s2">),</span>
                                   <span class="s1">order</span><span class="s2">=</span><span class="s1">model_rev</span><span class="s2">.</span><span class="s1">order</span><span class="s2">,</span>
                                   <span class="s1">seasonal_order</span><span class="s2">=</span><span class="s1">model_rev</span><span class="s2">.</span><span class="s1">seasonal_order</span><span class="s2">)</span>
                <span class="s1">full_model_fit </span><span class="s2">= </span><span class="s1">full_model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">()</span>

                <span class="s3"># Get forecast with proper confidence intervals</span>
                <span class="s1">forecast_result </span><span class="s2">= </span><span class="s1">full_model_fit</span><span class="s2">.</span><span class="s1">get_forecast</span><span class="s2">(</span><span class="s1">steps</span><span class="s2">=</span><span class="s1">forecast_steps</span><span class="s2">)</span>
                <span class="s1">forecast </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(</span><span class="s1">forecast_result</span><span class="s2">.</span><span class="s1">predicted_mean</span><span class="s2">)</span>
                <span class="s1">conf_int </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(</span><span class="s1">forecast_result</span><span class="s2">.</span><span class="s1">conf_int</span><span class="s2">())</span>

                <span class="s1">forecast_index </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">date_range</span><span class="s2">(</span><span class="s1">time_series_rev_smoothed</span><span class="s2">.</span><span class="s1">index</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">], </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">forecast_steps </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">,</span>
                                               <span class="s1">freq</span><span class="s2">=</span><span class="s4">'D'</span><span class="s2">)[</span><span class="s5">1</span><span class="s2">:]</span>

                <span class="s1">forecast_df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span>
                    <span class="s4">'date'</span><span class="s2">: </span><span class="s1">forecast_index</span><span class="s2">,</span>
                    <span class="s4">'mean'</span><span class="s2">: </span><span class="s1">forecast</span><span class="s2">,</span>
                    <span class="s4">'lower'</span><span class="s2">: </span><span class="s1">conf_int</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[:, </span><span class="s5">0</span><span class="s2">],</span>
                    <span class="s4">'upper'</span><span class="s2">: </span><span class="s1">conf_int</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[:, </span><span class="s5">1</span><span class="s2">]</span>
                <span class="s2">})</span>

                <span class="s3"># Plotting</span>
                <span class="s1">fig </span><span class="s2">= </span><span class="s1">go</span><span class="s2">.</span><span class="s1">Figure</span><span class="s2">()</span>

                <span class="s3"># Historical data (last 60 days)</span>
                <span class="s1">hist_data </span><span class="s2">= </span><span class="s1">time_series_rev_smoothed</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[-</span><span class="s5">60</span><span class="s2">:]</span>
                <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_trace</span><span class="s2">(</span><span class="s1">go</span><span class="s2">.</span><span class="s1">Scatter</span><span class="s2">(</span>
                    <span class="s1">x</span><span class="s2">=</span><span class="s1">hist_data</span><span class="s2">.</span><span class="s1">index</span><span class="s2">,</span>
                    <span class="s1">y</span><span class="s2">=</span><span class="s1">hist_data</span><span class="s2">,</span>
                    <span class="s1">mode</span><span class="s2">=</span><span class="s4">'lines'</span><span class="s2">,</span>
                    <span class="s1">name</span><span class="s2">=</span><span class="s4">'Historical Revenue'</span><span class="s2">,</span>
                    <span class="s1">line</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">color</span><span class="s2">=</span><span class="s4">'#1f77b4'</span><span class="s2">)</span>
                <span class="s2">))</span>

                <span class="s0">if </span><span class="s1">show_standard_dynamic_test</span><span class="s2">:</span>
                    <span class="s3"># Test data</span>
                    <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_trace</span><span class="s2">(</span><span class="s1">go</span><span class="s2">.</span><span class="s1">Scatter</span><span class="s2">(</span>
                        <span class="s1">x</span><span class="s2">=</span><span class="s1">test</span><span class="s2">.</span><span class="s1">index</span><span class="s2">,</span>
                        <span class="s1">y</span><span class="s2">=</span><span class="s1">test</span><span class="s2">,</span>
                        <span class="s1">mode</span><span class="s2">=</span><span class="s4">'lines'</span><span class="s2">,</span>
                        <span class="s1">name</span><span class="s2">=</span><span class="s4">'Test Data'</span><span class="s2">,</span>
                        <span class="s1">line</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">color</span><span class="s2">=</span><span class="s4">'#9467bd'</span><span class="s2">)</span>
                    <span class="s2">))</span>

                    <span class="s3"># Test forecast</span>
                    <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_trace</span><span class="s2">(</span><span class="s1">go</span><span class="s2">.</span><span class="s1">Scatter</span><span class="s2">(</span>
                        <span class="s1">x</span><span class="s2">=</span><span class="s1">test</span><span class="s2">.</span><span class="s1">index</span><span class="s2">,</span>
                        <span class="s1">y</span><span class="s2">=</span><span class="s1">test_forecast</span><span class="s2">,</span>
                        <span class="s1">mode</span><span class="s2">=</span><span class="s4">'lines'</span><span class="s2">,</span>
                        <span class="s1">name</span><span class="s2">=</span><span class="s4">'Standard Forecast'</span><span class="s2">,</span>
                        <span class="s1">line</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">color</span><span class="s2">=</span><span class="s4">'#8c564b'</span><span class="s2">, </span><span class="s1">dash</span><span class="s2">=</span><span class="s4">'dot'</span><span class="s2">)</span>
                    <span class="s2">))</span>

                    <span class="s3"># Dynamic forecast</span>
                    <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_trace</span><span class="s2">(</span><span class="s1">go</span><span class="s2">.</span><span class="s1">Scatter</span><span class="s2">(</span>
                        <span class="s1">x</span><span class="s2">=</span><span class="s1">test</span><span class="s2">.</span><span class="s1">index</span><span class="s2">,</span>
                        <span class="s1">y</span><span class="s2">=</span><span class="s1">dynamic_forecast</span><span class="s2">,</span>
                        <span class="s1">mode</span><span class="s2">=</span><span class="s4">'lines'</span><span class="s2">,</span>
                        <span class="s1">name</span><span class="s2">=</span><span class="s4">'Dynamic Forecast'</span><span class="s2">,</span>
                        <span class="s1">line</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">color</span><span class="s2">=</span><span class="s4">'#7f7f7f'</span><span class="s2">, </span><span class="s1">dash</span><span class="s2">=</span><span class="s4">'dash'</span><span class="s2">)</span>
                    <span class="s2">))</span>

                <span class="s3"># Future forecast</span>
                <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_trace</span><span class="s2">(</span><span class="s1">go</span><span class="s2">.</span><span class="s1">Scatter</span><span class="s2">(</span>
                    <span class="s1">x</span><span class="s2">=</span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'date'</span><span class="s2">],</span>
                    <span class="s1">y</span><span class="s2">=</span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'mean'</span><span class="s2">],</span>
                    <span class="s1">mode</span><span class="s2">=</span><span class="s4">'lines'</span><span class="s2">,</span>
                    <span class="s1">name</span><span class="s2">=</span><span class="s4">'Future Forecast'</span><span class="s2">,</span>
                    <span class="s1">line</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">color</span><span class="s2">=</span><span class="s4">'#ff7f0e'</span><span class="s2">, </span><span class="s1">dash</span><span class="s2">=</span><span class="s4">'dash'</span><span class="s2">)</span>
                <span class="s2">))</span>

                <span class="s3"># Confidence interval</span>
                <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_trace</span><span class="s2">(</span><span class="s1">go</span><span class="s2">.</span><span class="s1">Scatter</span><span class="s2">(</span>
                    <span class="s1">x</span><span class="s2">=</span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'date'</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() + </span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'date'</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">()[::-</span><span class="s5">1</span><span class="s2">],</span>
                    <span class="s1">y</span><span class="s2">=</span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'upper'</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() + </span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'lower'</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">()[::-</span><span class="s5">1</span><span class="s2">],</span>
                    <span class="s1">fill</span><span class="s2">=</span><span class="s4">'toself'</span><span class="s2">,</span>
                    <span class="s1">fillcolor</span><span class="s2">=</span><span class="s4">'rgba(255,111,97,0.2)'</span><span class="s2">,</span>
                    <span class="s1">line_color</span><span class="s2">=</span><span class="s4">'rgba(255,255,255,0)'</span><span class="s2">,</span>
                    <span class="s1">name</span><span class="s2">=</span><span class="s4">'95% Confidence'</span>
                <span class="s2">))</span>

                <span class="s1">fig</span><span class="s2">.</span><span class="s1">update_layout</span><span class="s2">(</span>
                    <span class="s1">title</span><span class="s2">=</span><span class="s4">f&quot;Revenue Forecast for </span><span class="s0">{</span><span class="s1">selected_product</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">,</span>
                    <span class="s1">xaxis_title</span><span class="s2">=</span><span class="s4">&quot;Date&quot;</span><span class="s2">,</span>
                    <span class="s1">yaxis_title</span><span class="s2">=</span><span class="s4">&quot;Predicted Sales (‚Ç±)&quot;</span><span class="s2">,</span>
                    <span class="s1">hovermode</span><span class="s2">=</span><span class="s4">&quot;x unified&quot;</span><span class="s2">,</span>
                    <span class="s1">legend</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">orientation</span><span class="s2">=</span><span class="s4">&quot;h&quot;</span><span class="s2">, </span><span class="s1">yanchor</span><span class="s2">=</span><span class="s4">&quot;bottom&quot;</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s5">1.02</span><span class="s2">, </span><span class="s1">xanchor</span><span class="s2">=</span><span class="s4">&quot;right&quot;</span><span class="s2">, </span><span class="s1">x</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
                <span class="s2">)</span>

                <span class="s1">st</span><span class="s2">.</span><span class="s1">plotly_chart</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">use_container_width</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

                <span class="s3"># Forecast summary table</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;üìã Forecast Summary&quot;</span><span class="s2">)</span>
                <span class="s1">forecast_display </span><span class="s2">= </span><span class="s1">forecast_df</span><span class="s2">[[</span><span class="s4">'date'</span><span class="s2">, </span><span class="s4">'mean'</span><span class="s2">]].</span><span class="s1">copy</span><span class="s2">()</span>
                <span class="s1">forecast_display</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= [</span><span class="s4">'Date'</span><span class="s2">, </span><span class="s4">'Forecasted Sales'</span><span class="s2">]</span>
                <span class="s1">forecast_display</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s4">'Date'</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
                <span class="s1">forecast_display </span><span class="s2">= </span><span class="s1">forecast_display</span><span class="s2">.</span><span class="s1">round</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">dataframe</span><span class="s2">(</span>
                    <span class="s1">forecast_display</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">format</span><span class="s2">({</span><span class="s4">&quot;Forecasted Sales&quot;</span><span class="s2">: </span><span class="s4">&quot;‚Ç±{:.2f}&quot;</span><span class="s2">}),</span>
                    <span class="s1">height</span><span class="s2">=</span><span class="s5">300</span>
                <span class="s2">)</span>

                <span class="s3"># Generate insights</span>
                <span class="s1">first_date </span><span class="s2">= </span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'date'</span><span class="s2">].</span><span class="s1">iloc</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">strftime</span><span class="s2">(</span><span class="s4">'%b %d'</span><span class="s2">)</span>
                <span class="s1">last_date </span><span class="s2">= </span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'date'</span><span class="s2">].</span><span class="s1">iloc</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">].</span><span class="s1">strftime</span><span class="s2">(</span><span class="s4">'%b %d'</span><span class="s2">)</span>
                <span class="s1">first_value </span><span class="s2">= </span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'mean'</span><span class="s2">].</span><span class="s1">iloc</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
                <span class="s1">last_value </span><span class="s2">= </span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'mean'</span><span class="s2">].</span><span class="s1">iloc</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">]</span>

                <span class="s0">if </span><span class="s1">show_standard_dynamic_test</span><span class="s2">:</span>
                    <span class="s1">insight_text </span><span class="s2">= </span><span class="s4">f&quot;&quot;&quot;</span>
                        <span class="s4">üìà **What This Means**</span>
                        <span class="s4">- Model accuracy on test data: MAE=‚Ç±</span><span class="s0">{</span><span class="s1">mae</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">}</span><span class="s4">, RMSE=‚Ç±</span><span class="s0">{</span><span class="s1">rmse</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">}</span>
                        <span class="s4">- Dynamic forecast accuracy: MAE=‚Ç±</span><span class="s0">{</span><span class="s1">dynamic_mae</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">}</span><span class="s4">, RMSE=‚Ç±</span><span class="s0">{</span><span class="s1">dynamic_rmse</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">}</span>
                        <span class="s4">- Expected sales around **‚Ç±</span><span class="s0">{</span><span class="s1">first_value</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">}</span><span class="s4">** on </span><span class="s0">{</span><span class="s1">first_date</span><span class="s0">}</span>
                        <span class="s4">- Forecast shows </span><span class="s0">{</span><span class="s4">'growth' </span><span class="s0">if </span><span class="s1">last_value </span><span class="s2">&gt; </span><span class="s1">first_value </span><span class="s0">else </span><span class="s4">'decline'</span><span class="s0">} </span><span class="s4">through </span><span class="s0">{</span><span class="s1">last_date</span><span class="s0">}</span>
                        <span class="s4">- Typical daily sales between **‚Ç±</span><span class="s0">{</span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'mean'</span><span class="s2">].</span><span class="s1">min</span><span class="s2">()</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">}</span><span class="s4">** - **‚Ç±</span><span class="s0">{</span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'mean'</span><span class="s2">].</span><span class="s1">max</span><span class="s2">()</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">}</span><span class="s4">**</span>
                    <span class="s4">&quot;&quot;&quot;</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">insight_text </span><span class="s2">= </span><span class="s4">f&quot;&quot;&quot;</span>
                        <span class="s4">üìà **What This Means**</span>
                        <span class="s4">- Expected sales around **‚Ç±</span><span class="s0">{</span><span class="s1">first_value</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">}</span><span class="s4">** on </span><span class="s0">{</span><span class="s1">first_date</span><span class="s0">}</span>
                        <span class="s4">- Forecast shows </span><span class="s0">{</span><span class="s4">'growth' </span><span class="s0">if </span><span class="s1">last_value </span><span class="s2">&gt; </span><span class="s1">first_value </span><span class="s0">else </span><span class="s4">'decline'</span><span class="s0">} </span><span class="s4">through </span><span class="s0">{</span><span class="s1">last_date</span><span class="s0">}</span>
                        <span class="s4">- Typical daily sales between **‚Ç±</span><span class="s0">{</span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'mean'</span><span class="s2">].</span><span class="s1">min</span><span class="s2">()</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">}</span><span class="s4">** - **‚Ç±</span><span class="s0">{</span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'mean'</span><span class="s2">].</span><span class="s1">max</span><span class="s2">()</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">}</span><span class="s4">**</span>
                    <span class="s4">&quot;&quot;&quot;</span>

                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">f&quot;&lt;div class='insight-box'&gt;</span><span class="s0">{</span><span class="s1">insight_text</span><span class="s0">}</span><span class="s4">&lt;/div&gt;&quot;</span><span class="s2">, </span><span class="s1">unsafe_allow_html</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

            <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s4">f&quot;Revenue forecast error: </span><span class="s0">{</span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s4">&quot;Try selecting a different seasonality period or product with more data&quot;</span><span class="s2">)</span>

            <span class="s0">with </span><span class="s1">col2</span><span class="s2">:</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;üì¶ Quantity Forecast&quot;</span><span class="s2">)</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s3"># Similar optimization for quantity forecast</span>
                    <span class="s3"># Train-test split</span>
                    <span class="s1">train_size </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">time_series_qty_smoothed</span><span class="s2">) - </span><span class="s5">30</span>
                    <span class="s1">train</span><span class="s2">, </span><span class="s1">test </span><span class="s2">= </span><span class="s1">time_series_qty_smoothed</span><span class="s2">[:</span><span class="s1">train_size</span><span class="s2">], </span><span class="s1">time_series_qty_smoothed</span><span class="s2">[</span><span class="s1">train_size</span><span class="s2">:]</span>

                    <span class="s3"># Automatic seasonality detection</span>
                    <span class="s1">decomposition </span><span class="s2">= </span><span class="s1">seasonal_decompose</span><span class="s2">(</span><span class="s1">train</span><span class="s2">, </span><span class="s1">period</span><span class="s2">=</span><span class="s5">7</span><span class="s2">)</span>
                    <span class="s1">seasonal_strength </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">decomposition</span><span class="s2">.</span><span class="s1">seasonal</span><span class="s2">).</span><span class="s1">mean</span><span class="s2">() / </span><span class="s1">decomposition</span><span class="s2">.</span><span class="s1">observed</span><span class="s2">.</span><span class="s1">std</span><span class="s2">()</span>
                    <span class="s1">use_seasonal </span><span class="s2">= </span><span class="s1">seasonal_strength </span><span class="s2">&gt; </span><span class="s5">0.4</span>

                    <span class="s3"># Log transform</span>
                    <span class="s1">train_log </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">(</span><span class="s1">train</span><span class="s2">)</span>

                    <span class="s3"># Auto ARIMA with improved configuration</span>
                    <span class="s1">model_qty </span><span class="s2">= </span><span class="s1">auto_arima</span><span class="s2">(</span>
                        <span class="s1">train_log</span><span class="s2">,</span>
                        <span class="s1">seasonal</span><span class="s2">=</span><span class="s1">use_seasonal</span><span class="s2">,</span>
                        <span class="s1">m</span><span class="s2">=</span><span class="s5">7 </span><span class="s0">if </span><span class="s1">use_seasonal </span><span class="s0">else </span><span class="s5">1</span><span class="s2">,</span>
                        <span class="s1">start_p</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
                        <span class="s1">start_q</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
                        <span class="s1">max_p</span><span class="s2">=</span><span class="s5">3</span><span class="s2">,</span>
                        <span class="s1">max_q</span><span class="s2">=</span><span class="s5">3</span><span class="s2">,</span>
                        <span class="s1">d</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
                        <span class="s1">max_d</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
                        <span class="s1">start_P</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
                        <span class="s1">start_Q</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
                        <span class="s1">max_P</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
                        <span class="s1">max_Q</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
                        <span class="s1">trace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                        <span class="s1">error_action</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">,</span>
                        <span class="s1">suppress_warnings</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                        <span class="s1">stepwise</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                        <span class="s1">information_criterion</span><span class="s2">=</span><span class="s4">'aic'</span><span class="s2">,</span>
                        <span class="s1">n_jobs</span><span class="s2">=-</span><span class="s5">1</span>
                    <span class="s2">)</span>

                    <span class="s1">st</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s4">f&quot;Optimized SARIMA order: </span><span class="s0">{</span><span class="s1">model_qty</span><span class="s2">.</span><span class="s1">order</span><span class="s0">}</span><span class="s4">, seasonal order: </span><span class="s0">{</span><span class="s1">model_qty</span><span class="s2">.</span><span class="s1">seasonal_order</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>

                    <span class="s3"># Forecast evaluation</span>
                    <span class="s1">test_forecast_log </span><span class="s2">= </span><span class="s1">model_qty</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">n_periods</span><span class="s2">=</span><span class="s1">len</span><span class="s2">(</span><span class="s1">test</span><span class="s2">))</span>
                    <span class="s1">test_forecast </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(</span><span class="s1">test_forecast_log</span><span class="s2">)</span>

                    <span class="s3"># Dynamic forecasting</span>
                    <span class="s1">history </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">train_log</span><span class="s2">)</span>
                    <span class="s1">dynamic_forecast </span><span class="s2">= []</span>
                    <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">test</span><span class="s2">)):</span>
                        <span class="s1">model </span><span class="s2">= </span><span class="s1">ARIMA</span><span class="s2">(</span><span class="s1">history</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s1">model_qty</span><span class="s2">.</span><span class="s1">order</span><span class="s2">, </span><span class="s1">seasonal_order</span><span class="s2">=</span><span class="s1">model_qty</span><span class="s2">.</span><span class="s1">seasonal_order</span><span class="s2">)</span>
                        <span class="s1">model_fit </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">()</span>
                        <span class="s1">output </span><span class="s2">= </span><span class="s1">model_fit</span><span class="s2">.</span><span class="s1">forecast</span><span class="s2">()</span>
                        <span class="s1">dynamic_forecast</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">output</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
                        <span class="s1">history</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s1">t</span><span class="s2">]))</span>

                    <span class="s1">dynamic_forecast </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(</span><span class="s1">dynamic_forecast</span><span class="s2">)</span>

                    <span class="s1">mae </span><span class="s2">= </span><span class="s1">mean_absolute_error</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">test_forecast</span><span class="s2">)</span>
                    <span class="s1">rmse </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">mean_squared_error</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">test_forecast</span><span class="s2">))</span>
                    <span class="s1">dynamic_mae </span><span class="s2">= </span><span class="s1">mean_absolute_error</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">dynamic_forecast</span><span class="s2">)</span>
                    <span class="s1">dynamic_rmse </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">mean_squared_error</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">dynamic_forecast</span><span class="s2">))</span>

                    <span class="s0">if </span><span class="s1">show_standard_dynamic_test</span><span class="s2">:</span>
                        <span class="s1">st</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s4">f&quot;Standard Test Performance: MAE=</span><span class="s0">{</span><span class="s1">mae</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">units, RMSE=</span><span class="s0">{</span><span class="s1">rmse</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">units&quot;</span><span class="s2">)</span>
                        <span class="s1">st</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span>
                            <span class="s4">f&quot;Dynamic Test Performance: MAE=</span><span class="s0">{</span><span class="s1">dynamic_mae</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">units, RMSE=</span><span class="s0">{</span><span class="s1">dynamic_rmse</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">units&quot;</span><span class="s2">)</span>

                    <span class="s3"># Final forecast</span>
                    <span class="s1">forecast_steps </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">slider</span><span class="s2">(</span><span class="s4">&quot;Forecast Days (Quantity)&quot;</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">31</span><span class="s2">, </span><span class="s5">14</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;qty_forecast&quot;</span><span class="s2">)</span>

                    <span class="s3"># Refit on full data</span>
                    <span class="s1">full_model </span><span class="s2">= </span><span class="s1">ARIMA</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">(</span><span class="s1">time_series_qty_smoothed</span><span class="s2">),</span>
                                       <span class="s1">order</span><span class="s2">=</span><span class="s1">model_qty</span><span class="s2">.</span><span class="s1">order</span><span class="s2">,</span>
                                       <span class="s1">seasonal_order</span><span class="s2">=</span><span class="s1">model_qty</span><span class="s2">.</span><span class="s1">seasonal_order</span><span class="s2">)</span>
                    <span class="s1">full_model_fit </span><span class="s2">= </span><span class="s1">full_model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">()</span>

                    <span class="s1">forecast_result </span><span class="s2">= </span><span class="s1">full_model_fit</span><span class="s2">.</span><span class="s1">get_forecast</span><span class="s2">(</span><span class="s1">steps</span><span class="s2">=</span><span class="s1">forecast_steps</span><span class="s2">)</span>
                    <span class="s1">forecast </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(</span><span class="s1">forecast_result</span><span class="s2">.</span><span class="s1">predicted_mean</span><span class="s2">)</span>
                    <span class="s1">conf_int </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(</span><span class="s1">forecast_result</span><span class="s2">.</span><span class="s1">conf_int</span><span class="s2">())</span>

                    <span class="s1">forecast_index </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">date_range</span><span class="s2">(</span><span class="s1">time_series_qty_smoothed</span><span class="s2">.</span><span class="s1">index</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">], </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">forecast_steps </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">,</span>
                                                   <span class="s1">freq</span><span class="s2">=</span><span class="s4">'D'</span><span class="s2">)[</span><span class="s5">1</span><span class="s2">:]</span>

                    <span class="s1">forecast_df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span>
                        <span class="s4">'date'</span><span class="s2">: </span><span class="s1">forecast_index</span><span class="s2">,</span>
                        <span class="s4">'mean'</span><span class="s2">: </span><span class="s1">forecast</span><span class="s2">,</span>
                        <span class="s4">'lower'</span><span class="s2">: </span><span class="s1">conf_int</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[:, </span><span class="s5">0</span><span class="s2">],</span>
                        <span class="s4">'upper'</span><span class="s2">: </span><span class="s1">conf_int</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[:, </span><span class="s5">1</span><span class="s2">]</span>
                    <span class="s2">})</span>

                    <span class="s3"># Store forecast in session state</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">session_state</span><span class="s2">.</span><span class="s1">quantity_forecast </span><span class="s2">= {</span>
                        <span class="s4">'forecast_df'</span><span class="s2">: </span><span class="s1">forecast_df</span><span class="s2">,</span>
                        <span class="s4">'generated_date'</span><span class="s2">: </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">now</span><span class="s2">().</span><span class="s1">date</span><span class="s2">()</span>
                    <span class="s2">}</span>

                    <span class="s3"># Historical data graph</span>
                    <span class="s1">fig </span><span class="s2">= </span><span class="s1">go</span><span class="s2">.</span><span class="s1">Figure</span><span class="s2">()</span>

                    <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_trace</span><span class="s2">(</span><span class="s1">go</span><span class="s2">.</span><span class="s1">Scatter</span><span class="s2">(</span>
                        <span class="s1">x</span><span class="s2">=</span><span class="s1">time_series_qty_smoothed</span><span class="s2">.</span><span class="s1">index</span><span class="s2">[-</span><span class="s5">60</span><span class="s2">:],</span>
                        <span class="s1">y</span><span class="s2">=</span><span class="s1">time_series_qty_smoothed</span><span class="s2">[-</span><span class="s5">60</span><span class="s2">:],</span>
                        <span class="s1">mode</span><span class="s2">=</span><span class="s4">'lines'</span><span class="s2">,</span>
                        <span class="s1">name</span><span class="s2">=</span><span class="s4">'Historical Quantity'</span><span class="s2">,</span>
                        <span class="s1">line</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">color</span><span class="s2">=</span><span class="s4">'#2ca02c'</span><span class="s2">)</span>
                    <span class="s2">))</span>

                    <span class="s0">if </span><span class="s1">show_standard_dynamic_test</span><span class="s2">:</span>
                        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_trace</span><span class="s2">(</span><span class="s1">go</span><span class="s2">.</span><span class="s1">Scatter</span><span class="s2">(</span>
                            <span class="s1">x</span><span class="s2">=</span><span class="s1">test</span><span class="s2">.</span><span class="s1">index</span><span class="s2">,</span>
                            <span class="s1">y</span><span class="s2">=</span><span class="s1">test</span><span class="s2">,</span>
                            <span class="s1">mode</span><span class="s2">=</span><span class="s4">'lines'</span><span class="s2">,</span>
                            <span class="s1">name</span><span class="s2">=</span><span class="s4">'Test Data'</span><span class="s2">,</span>
                            <span class="s1">line</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">color</span><span class="s2">=</span><span class="s4">'#e377c2'</span><span class="s2">)</span>
                        <span class="s2">))</span>

                        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_trace</span><span class="s2">(</span><span class="s1">go</span><span class="s2">.</span><span class="s1">Scatter</span><span class="s2">(</span>
                            <span class="s1">x</span><span class="s2">=</span><span class="s1">test</span><span class="s2">.</span><span class="s1">index</span><span class="s2">,</span>
                            <span class="s1">y</span><span class="s2">=</span><span class="s1">test_forecast</span><span class="s2">,</span>
                            <span class="s1">mode</span><span class="s2">=</span><span class="s4">'lines'</span><span class="s2">,</span>
                            <span class="s1">name</span><span class="s2">=</span><span class="s4">'Standard Forecast'</span><span class="s2">,</span>
                            <span class="s1">line</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">color</span><span class="s2">=</span><span class="s4">'#7f7f7f'</span><span class="s2">, </span><span class="s1">dash</span><span class="s2">=</span><span class="s4">'dot'</span><span class="s2">)</span>
                        <span class="s2">))</span>

                        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_trace</span><span class="s2">(</span><span class="s1">go</span><span class="s2">.</span><span class="s1">Scatter</span><span class="s2">(</span>
                            <span class="s1">x</span><span class="s2">=</span><span class="s1">test</span><span class="s2">.</span><span class="s1">index</span><span class="s2">,</span>
                            <span class="s1">y</span><span class="s2">=</span><span class="s1">dynamic_forecast</span><span class="s2">,</span>
                            <span class="s1">mode</span><span class="s2">=</span><span class="s4">'lines'</span><span class="s2">,</span>
                            <span class="s1">name</span><span class="s2">=</span><span class="s4">'Dynamic Forecast'</span><span class="s2">,</span>
                            <span class="s1">line</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">color</span><span class="s2">=</span><span class="s4">'#d62728'</span><span class="s2">, </span><span class="s1">dash</span><span class="s2">=</span><span class="s4">'dash'</span><span class="s2">)</span>
                        <span class="s2">))</span>

                    <span class="s3"># Future forecast</span>
                    <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_trace</span><span class="s2">(</span><span class="s1">go</span><span class="s2">.</span><span class="s1">Scatter</span><span class="s2">(</span>
                        <span class="s1">x</span><span class="s2">=</span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'date'</span><span class="s2">],</span>
                        <span class="s1">y</span><span class="s2">=</span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'mean'</span><span class="s2">],</span>
                        <span class="s1">mode</span><span class="s2">=</span><span class="s4">'lines'</span><span class="s2">,</span>
                        <span class="s1">name</span><span class="s2">=</span><span class="s4">'Future Forecast'</span><span class="s2">,</span>
                        <span class="s1">line</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">color</span><span class="s2">=</span><span class="s4">'#d62728'</span><span class="s2">, </span><span class="s1">dash</span><span class="s2">=</span><span class="s4">'dash'</span><span class="s2">)</span>
                    <span class="s2">))</span>

                    <span class="s3"># Confidence interval</span>
                    <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_trace</span><span class="s2">(</span><span class="s1">go</span><span class="s2">.</span><span class="s1">Scatter</span><span class="s2">(</span>
                        <span class="s1">x</span><span class="s2">=</span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'date'</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() + </span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'date'</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">()[::-</span><span class="s5">1</span><span class="s2">],</span>
                        <span class="s1">y</span><span class="s2">=</span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'upper'</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() + </span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'lower'</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">()[::-</span><span class="s5">1</span><span class="s2">],</span>
                        <span class="s1">fill</span><span class="s2">=</span><span class="s4">'toself'</span><span class="s2">,</span>
                        <span class="s1">fillcolor</span><span class="s2">=</span><span class="s4">'rgba(97,210,214,0.2)'</span><span class="s2">,</span>
                        <span class="s1">line_color</span><span class="s2">=</span><span class="s4">'rgba(255,255,255,0)'</span><span class="s2">,</span>
                        <span class="s1">name</span><span class="s2">=</span><span class="s4">'95% Confidence'</span>
                    <span class="s2">))</span>

                    <span class="s1">fig</span><span class="s2">.</span><span class="s1">update_layout</span><span class="s2">(</span>
                        <span class="s1">title</span><span class="s2">=</span><span class="s4">f&quot;Quantity Forecast for </span><span class="s0">{</span><span class="s1">selected_product</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">,</span>
                        <span class="s1">xaxis_title</span><span class="s2">=</span><span class="s4">&quot;Date&quot;</span><span class="s2">,</span>
                        <span class="s1">yaxis_title</span><span class="s2">=</span><span class="s4">&quot;Predicted Units&quot;</span><span class="s2">,</span>
                        <span class="s1">hovermode</span><span class="s2">=</span><span class="s4">&quot;x unified&quot;</span><span class="s2">,</span>
                        <span class="s1">legend</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">orientation</span><span class="s2">=</span><span class="s4">&quot;h&quot;</span><span class="s2">, </span><span class="s1">yanchor</span><span class="s2">=</span><span class="s4">&quot;bottom&quot;</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s5">1.02</span><span class="s2">, </span><span class="s1">xanchor</span><span class="s2">=</span><span class="s4">&quot;right&quot;</span><span class="s2">, </span><span class="s1">x</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
                    <span class="s2">)</span>

                    <span class="s1">st</span><span class="s2">.</span><span class="s1">plotly_chart</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">use_container_width</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

                    <span class="s3"># Forecast summary table</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;üìã Forecast Summary&quot;</span><span class="s2">)</span>
                    <span class="s1">forecast_display </span><span class="s2">= </span><span class="s1">forecast_df</span><span class="s2">[[</span><span class="s4">'date'</span><span class="s2">, </span><span class="s4">'mean'</span><span class="s2">]].</span><span class="s1">copy</span><span class="s2">()</span>
                    <span class="s1">forecast_display</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= [</span><span class="s4">'Date'</span><span class="s2">, </span><span class="s4">'Forecasted Units'</span><span class="s2">]</span>
                    <span class="s1">forecast_display</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s4">'Date'</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
                    <span class="s1">forecast_display </span><span class="s2">= </span><span class="s1">forecast_display</span><span class="s2">.</span><span class="s1">round</span><span class="s2">(</span><span class="s5">0</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">dataframe</span><span class="s2">(</span>
                        <span class="s1">forecast_display</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">format</span><span class="s2">({</span><span class="s4">&quot;Forecasted Units&quot;</span><span class="s2">: </span><span class="s4">&quot;{:.0f} units&quot;</span><span class="s2">}),</span>
                        <span class="s1">height</span><span class="s2">=</span><span class="s5">300</span>
                    <span class="s2">)</span>

                    <span class="s3"># Generate simple insights</span>
                    <span class="s1">avg_units </span><span class="s2">= </span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'mean'</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">().</span><span class="s1">round</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
                    <span class="s1">peak_day </span><span class="s2">= </span><span class="s1">forecast_df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'mean'</span><span class="s2">].</span><span class="s1">idxmax</span><span class="s2">()]</span>

                    <span class="s0">if </span><span class="s1">show_standard_dynamic_test</span><span class="s2">:</span>
                        <span class="s1">insight_text </span><span class="s2">= </span><span class="s4">f&quot;&quot;&quot;</span>
                            <span class="s4">üì¶ **What This Means**</span>
                            <span class="s4">- Model accuracy on test data: MAE=</span><span class="s0">{</span><span class="s1">mae</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">units, RMSE=</span><span class="s0">{</span><span class="s1">rmse</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">units  </span>
                            <span class="s4">- Dynamic forecast accuracy: MAE=</span><span class="s0">{</span><span class="s1">dynamic_mae</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">units, RMSE=</span><span class="s0">{</span><span class="s1">dynamic_rmse</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">units</span>
                            <span class="s4">- Expected to sell **</span><span class="s0">{</span><span class="s1">avg_units</span><span class="s0">:</span><span class="s4">.0f</span><span class="s0">} </span><span class="s4">units** daily on average  </span>
                            <span class="s4">- Highest demand predicted on **</span><span class="s0">{</span><span class="s1">peak_day</span><span class="s2">[</span><span class="s4">'date'</span><span class="s2">].</span><span class="s1">strftime</span><span class="s2">(</span><span class="s4">'%b %d'</span><span class="s2">)</span><span class="s0">}</span><span class="s4">** (</span><span class="s0">{</span><span class="s1">peak_day</span><span class="s2">[</span><span class="s4">'mean'</span><span class="s2">]</span><span class="s0">:</span><span class="s4">.0f</span><span class="s0">} </span><span class="s4">units)  </span>
                            <span class="s4">- Daily forecasts range from **</span><span class="s0">{</span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'mean'</span><span class="s2">].</span><span class="s1">min</span><span class="s2">()</span><span class="s0">:</span><span class="s4">.0f</span><span class="s0">}</span><span class="s4">** to **</span><span class="s0">{</span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'mean'</span><span class="s2">].</span><span class="s1">max</span><span class="s2">()</span><span class="s0">:</span><span class="s4">.0f</span><span class="s0">}</span><span class="s4">** units  </span>
                        <span class="s4">&quot;&quot;&quot;</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">insight_text </span><span class="s2">= </span><span class="s4">f&quot;&quot;&quot;</span>
                            <span class="s4">üì¶ **What This Means**</span>
                            <span class="s4">- Expected to sell **</span><span class="s0">{</span><span class="s1">avg_units</span><span class="s0">:</span><span class="s4">.0f</span><span class="s0">} </span><span class="s4">units** daily on average</span>
                            <span class="s4">- Highest demand predicted on **</span><span class="s0">{</span><span class="s1">peak_day</span><span class="s2">[</span><span class="s4">'date'</span><span class="s2">].</span><span class="s1">strftime</span><span class="s2">(</span><span class="s4">'%b %d'</span><span class="s2">)</span><span class="s0">}</span><span class="s4">** (</span><span class="s0">{</span><span class="s1">peak_day</span><span class="s2">[</span><span class="s4">'mean'</span><span class="s2">]</span><span class="s0">:</span><span class="s4">.0f</span><span class="s0">} </span><span class="s4">units)</span>
                            <span class="s4">- Daily forecasts range from **</span><span class="s0">{</span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'mean'</span><span class="s2">].</span><span class="s1">min</span><span class="s2">()</span><span class="s0">:</span><span class="s4">.0f</span><span class="s0">}</span><span class="s4">** to **</span><span class="s0">{</span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'mean'</span><span class="s2">].</span><span class="s1">max</span><span class="s2">()</span><span class="s0">:</span><span class="s4">.0f</span><span class="s0">}</span><span class="s4">** units</span>
                        <span class="s4">&quot;&quot;&quot;</span>

                    <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">f&quot;&lt;div class='insight-box'&gt;</span><span class="s0">{</span><span class="s1">insight_text</span><span class="s0">}</span><span class="s4">&lt;/div&gt;&quot;</span><span class="s2">, </span><span class="s1">unsafe_allow_html</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

                <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s4">f&quot;Quantity forecast error: </span><span class="s0">{</span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s4">&quot;Try selecting a different seasonality period or product with more data&quot;</span><span class="s2">)</span>

        <span class="s3"># Sales Analysis Section</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">header</span><span class="s2">(</span><span class="s4">&quot;üìä Product Sales Trend Analysis&quot;</span><span class="s2">)</span>
        <span class="s1">current_month </span><span class="s2">= </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">now</span><span class="s2">().</span><span class="s1">strftime</span><span class="s2">(</span><span class="s4">'%B'</span><span class="s2">)</span>
        <span class="s1">months </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[</span><span class="s4">'Date'</span><span class="s2">].</span><span class="s1">dt</span><span class="s2">.</span><span class="s1">strftime</span><span class="s2">(</span><span class="s4">'%B'</span><span class="s2">).</span><span class="s1">unique</span><span class="s2">(),</span>
                        <span class="s1">key</span><span class="s2">=</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s1">calendar</span><span class="s2">.</span><span class="s1">month_name</span><span class="s2">).</span><span class="s1">index</span><span class="s2">(</span><span class="s1">x</span><span class="s2">))</span>
        <span class="s1">selected_month </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">selectbox</span><span class="s2">(</span><span class="s4">&quot;Select Month&quot;</span><span class="s2">, </span><span class="s1">months</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">months</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">current_month</span><span class="s2">))</span>

        <span class="s0">if </span><span class="s1">selected_product </span><span class="s2">!= </span><span class="s4">&quot;Choose Product&quot;</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s3"># Prepare data with enhanced formatting</span>
                <span class="s1">monthly_data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[(</span><span class="s1">data</span><span class="s2">[</span><span class="s4">'Date'</span><span class="s2">].</span><span class="s1">dt</span><span class="s2">.</span><span class="s1">strftime</span><span class="s2">(</span><span class="s4">'%B'</span><span class="s2">) == </span><span class="s1">selected_month</span><span class="s2">) &amp;</span>
                                    <span class="s2">(</span><span class="s1">data</span><span class="s2">[</span><span class="s4">'Item'</span><span class="s2">] == </span><span class="s1">selected_product</span><span class="s2">)]</span>

                <span class="s1">yearly_comparison </span><span class="s2">= </span><span class="s1">monthly_data</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">monthly_data</span><span class="s2">[</span><span class="s4">'Date'</span><span class="s2">].</span><span class="s1">dt</span><span class="s2">.</span><span class="s1">year</span><span class="s2">)[</span><span class="s4">'Quantity'</span><span class="s2">] </span><span class="s1">\</span>
                    <span class="s2">.</span><span class="s1">sum</span><span class="s2">() </span><span class="s1">\</span>
                    <span class="s2">.</span><span class="s1">reset_index</span><span class="s2">() </span><span class="s1">\</span>
                    <span class="s2">.</span><span class="s1">rename</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">={</span><span class="s4">'Date'</span><span class="s2">: </span><span class="s4">'Year'</span><span class="s2">})</span>

                <span class="s1">yearly_comparison</span><span class="s2">[</span><span class="s4">'Year'</span><span class="s2">] = </span><span class="s1">yearly_comparison</span><span class="s2">[</span><span class="s4">'Year'</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">str</span><span class="s2">)</span>
                <span class="s1">yearly_comparison</span><span class="s2">[</span><span class="s4">'Formatted_Qty'</span><span class="s2">] = </span><span class="s1">yearly_comparison</span><span class="s2">[</span><span class="s4">'Quantity'</span><span class="s2">].</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">x</span><span class="s0">:</span><span class="s4">,</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>

                <span class="s3"># Add forecast if viewing current month and forecast exists</span>
                <span class="s0">if </span><span class="s2">(</span><span class="s1">selected_month </span><span class="s2">== </span><span class="s1">current_month </span><span class="s0">and</span>
                        <span class="s4">'quantity_forecast' </span><span class="s0">in </span><span class="s1">st</span><span class="s2">.</span><span class="s1">session_state </span><span class="s0">and</span>
                        <span class="s1">st</span><span class="s2">.</span><span class="s1">session_state</span><span class="s2">.</span><span class="s1">quantity_forecast</span><span class="s2">[</span><span class="s4">'generated_date'</span><span class="s2">] == </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">now</span><span class="s2">().</span><span class="s1">date</span><span class="s2">()):</span>

                    <span class="s1">forecast_df </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">session_state</span><span class="s2">.</span><span class="s1">quantity_forecast</span><span class="s2">[</span><span class="s4">'forecast_df'</span><span class="s2">]</span>
                    <span class="s1">current_month_num </span><span class="s2">= </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">now</span><span class="s2">().</span><span class="s1">month</span>
                    <span class="s1">current_year </span><span class="s2">= </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">now</span><span class="s2">().</span><span class="s1">year</span>

                    <span class="s3"># Get all forecasts for current month</span>
                    <span class="s1">monthly_forecast </span><span class="s2">= </span><span class="s1">forecast_df</span><span class="s2">[</span>
                        <span class="s2">(</span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'date'</span><span class="s2">].</span><span class="s1">dt</span><span class="s2">.</span><span class="s1">month </span><span class="s2">== </span><span class="s1">current_month_num</span><span class="s2">) &amp;</span>
                        <span class="s2">(</span><span class="s1">forecast_df</span><span class="s2">[</span><span class="s4">'date'</span><span class="s2">].</span><span class="s1">dt</span><span class="s2">.</span><span class="s1">year </span><span class="s2">== </span><span class="s1">current_year</span><span class="s2">)</span>
                        <span class="s2">]</span>

                    <span class="s0">if not </span><span class="s1">monthly_forecast</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">:</span>
                        <span class="s1">forecast_total </span><span class="s2">= </span><span class="s1">monthly_forecast</span><span class="s2">[</span><span class="s4">'mean'</span><span class="s2">].</span><span class="s1">sum</span><span class="s2">().</span><span class="s1">round</span><span class="s2">()</span>
                        <span class="s1">yearly_comparison </span><span class="s2">= </span><span class="s1">yearly_comparison</span><span class="s2">.</span><span class="s1">append</span><span class="s2">({</span>
                            <span class="s4">'Year'</span><span class="s2">: </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">current_year</span><span class="s0">} </span><span class="s4">(Forecast)&quot;</span><span class="s2">,</span>
                            <span class="s4">'Quantity'</span><span class="s2">: </span><span class="s1">forecast_total</span><span class="s2">,</span>
                            <span class="s4">'Formatted_Qty'</span><span class="s2">: </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">forecast_total</span><span class="s0">:</span><span class="s4">,.0f</span><span class="s0">} </span><span class="s4">(forecast)&quot;</span>
                        <span class="s2">}, </span><span class="s1">ignore_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

                <span class="s3"># Create the visualization figure</span>
                <span class="s1">fig </span><span class="s2">= </span><span class="s1">go</span><span class="s2">.</span><span class="s1">Figure</span><span class="s2">()</span>

                <span class="s3"># Add bars - different color for forecast</span>
                <span class="s1">colors </span><span class="s2">= [</span><span class="s4">'#FFA15A' </span><span class="s0">if </span><span class="s4">'(Forecast)' </span><span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">year</span><span class="s2">) </span><span class="s0">else </span><span class="s4">'#4C78A8'</span>
                          <span class="s0">for </span><span class="s1">year </span><span class="s0">in </span><span class="s1">yearly_comparison</span><span class="s2">[</span><span class="s4">'Year'</span><span class="s2">]]</span>

                <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_trace</span><span class="s2">(</span><span class="s1">go</span><span class="s2">.</span><span class="s1">Bar</span><span class="s2">(</span>
                    <span class="s1">x</span><span class="s2">=</span><span class="s1">yearly_comparison</span><span class="s2">[</span><span class="s4">'Year'</span><span class="s2">],</span>
                    <span class="s1">y</span><span class="s2">=</span><span class="s1">yearly_comparison</span><span class="s2">[</span><span class="s4">'Quantity'</span><span class="s2">],</span>
                    <span class="s1">marker_color</span><span class="s2">=</span><span class="s1">colors</span><span class="s2">,</span>
                    <span class="s1">text</span><span class="s2">=</span><span class="s1">yearly_comparison</span><span class="s2">[</span><span class="s4">'Formatted_Qty'</span><span class="s2">],</span>
                    <span class="s1">textposition</span><span class="s2">=</span><span class="s4">'outside'</span><span class="s2">,</span>
                    <span class="s1">name</span><span class="s2">=</span><span class="s4">'Sales'</span>
                <span class="s2">))</span>

                <span class="s3"># Add trendline (only using historical data)</span>
                <span class="s1">historical_data </span><span class="s2">= </span><span class="s1">yearly_comparison</span><span class="s2">[~</span><span class="s1">yearly_comparison</span><span class="s2">[</span><span class="s4">'Year'</span><span class="s2">].</span><span class="s1">str</span><span class="s2">.</span><span class="s1">contains</span><span class="s2">(</span><span class="s4">&quot;Forecast&quot;</span><span class="s2">)]</span>
                <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">historical_data</span><span class="s2">) &gt;= </span><span class="s5">2</span><span class="s2">:</span>
                    <span class="s0">try</span><span class="s2">:</span>
                        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">historical_data</span><span class="s2">))</span>
                        <span class="s1">y </span><span class="s2">= </span><span class="s1">historical_data</span><span class="s2">[</span><span class="s4">'Quantity'</span><span class="s2">]</span>
                        <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">polyfit</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
                        <span class="s1">p </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">poly1d</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)</span>

                        <span class="s3"># Calculate trendline metrics</span>
                        <span class="s1">y_mean </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)</span>
                        <span class="s1">ss_tot </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">((</span><span class="s1">y </span><span class="s2">- </span><span class="s1">y_mean</span><span class="s2">) ** </span><span class="s5">2</span><span class="s2">)</span>
                        <span class="s1">ss_res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">((</span><span class="s1">y </span><span class="s2">- </span><span class="s1">p</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)) ** </span><span class="s5">2</span><span class="s2">)</span>
                        <span class="s1">r_squared </span><span class="s2">= </span><span class="s5">1 </span><span class="s2">- (</span><span class="s1">ss_res </span><span class="s2">/ </span><span class="s1">ss_tot</span><span class="s2">)</span>

                        <span class="s3"># Create trendline coordinates</span>
                        <span class="s1">trend_x </span><span class="s2">= </span><span class="s1">historical_data</span><span class="s2">[</span><span class="s4">'Year'</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">()</span>
                        <span class="s1">trend_y </span><span class="s2">= </span><span class="s1">p</span><span class="s2">(</span><span class="s1">x</span><span class="s2">).</span><span class="s1">tolist</span><span class="s2">()</span>

                        <span class="s3"># Extend to forecast position if present</span>
                        <span class="s0">if </span><span class="s4">&quot;(Forecast)&quot; </span><span class="s0">in </span><span class="s1">yearly_comparison</span><span class="s2">[</span><span class="s4">'Year'</span><span class="s2">].</span><span class="s1">values</span><span class="s2">:</span>
                            <span class="s1">trend_x</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">yearly_comparison</span><span class="s2">[</span><span class="s4">'Year'</span><span class="s2">].</span><span class="s1">iloc</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">])</span>
                            <span class="s1">trend_y</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">p</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">historical_data</span><span class="s2">)))</span>

                        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_trace</span><span class="s2">(</span><span class="s1">go</span><span class="s2">.</span><span class="s1">Scatter</span><span class="s2">(</span>
                            <span class="s1">x</span><span class="s2">=</span><span class="s1">trend_x</span><span class="s2">,</span>
                            <span class="s1">y</span><span class="s2">=</span><span class="s1">trend_y</span><span class="s2">,</span>
                            <span class="s1">mode</span><span class="s2">=</span><span class="s4">'lines+markers'</span><span class="s2">,</span>
                            <span class="s1">name</span><span class="s2">=</span><span class="s4">'Sales Trend'</span><span class="s2">,</span>
                            <span class="s1">line</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span>
                                <span class="s1">color</span><span class="s2">=</span><span class="s4">'#E45756'</span><span class="s2">,</span>
                                <span class="s1">width</span><span class="s2">=</span><span class="s5">3</span><span class="s2">,</span>
                                <span class="s1">shape</span><span class="s2">=</span><span class="s4">'spline'</span><span class="s2">,</span>
                                <span class="s1">smoothing</span><span class="s2">=</span><span class="s5">0.6</span>
                            <span class="s2">),</span>
                            <span class="s1">marker</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span>
                                <span class="s1">size</span><span class="s2">=</span><span class="s5">10</span><span class="s2">,</span>
                                <span class="s1">color</span><span class="s2">=</span><span class="s4">'#E45756'</span><span class="s2">,</span>
                                <span class="s1">symbol</span><span class="s2">=</span><span class="s4">'diamond'</span><span class="s2">,</span>
                                <span class="s1">line</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">width</span><span class="s2">=</span><span class="s5">1.5</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'#2D3F50'</span><span class="s2">)</span>
                            <span class="s2">),</span>
                            <span class="s1">hovertemplate</span><span class="s2">=</span><span class="s4">&quot;&lt;b&gt;Trend Value&lt;/b&gt;&lt;br&gt;%{y:.1f} units&lt;extra&gt;&lt;/extra&gt;&quot;</span>
                        <span class="s2">))</span>

                        <span class="s3"># Add trendline equation annotation</span>
                        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_annotation</span><span class="s2">(</span>
                            <span class="s1">x</span><span class="s2">=</span><span class="s5">0.05</span><span class="s2">,</span>
                            <span class="s1">y</span><span class="s2">=</span><span class="s5">0.95</span><span class="s2">,</span>
                            <span class="s1">xref</span><span class="s2">=</span><span class="s4">'paper'</span><span class="s2">,</span>
                            <span class="s1">yref</span><span class="s2">=</span><span class="s4">'paper'</span><span class="s2">,</span>
                            <span class="s1">text</span><span class="s2">=</span><span class="s4">f&quot;Trend: y = </span><span class="s0">{</span><span class="s1">z</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span><span class="s0">:</span><span class="s4">.1f</span><span class="s0">}</span><span class="s4">x + </span><span class="s0">{</span><span class="s1">z</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span><span class="s0">:</span><span class="s4">.1f</span><span class="s0">}</span><span class="s4">&lt;br&gt;R¬≤ = </span><span class="s0">{</span><span class="s1">r_squared</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">,</span>
                            <span class="s1">showarrow</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
                            <span class="s1">font</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s5">12</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'#2D3F50'</span><span class="s2">),</span>
                            <span class="s1">bgcolor</span><span class="s2">=</span><span class="s4">'rgba(255,255,255,0.9)'</span><span class="s2">,</span>
                            <span class="s1">bordercolor</span><span class="s2">=</span><span class="s4">'#2D3F50'</span><span class="s2">,</span>
                            <span class="s1">borderwidth</span><span class="s2">=</span><span class="s5">1</span>
                        <span class="s2">)</span>

                    <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                        <span class="s1">st</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s4">f&quot;Trend analysis limited: </span><span class="s0">{</span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>

                <span class="s3"># Add forecast annotation if present</span>
                <span class="s0">if </span><span class="s4">&quot;(Forecast)&quot; </span><span class="s0">in </span><span class="s1">yearly_comparison</span><span class="s2">[</span><span class="s4">'Year'</span><span class="s2">].</span><span class="s1">values</span><span class="s2">:</span>
                    <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_annotation</span><span class="s2">(</span>
                        <span class="s1">x</span><span class="s2">=</span><span class="s1">yearly_comparison</span><span class="s2">[</span><span class="s4">'Year'</span><span class="s2">].</span><span class="s1">iloc</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">],</span>
                        <span class="s1">y</span><span class="s2">=</span><span class="s1">yearly_comparison</span><span class="s2">[</span><span class="s4">'Quantity'</span><span class="s2">].</span><span class="s1">iloc</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">],</span>
                        <span class="s1">text</span><span class="s2">=</span><span class="s4">&quot;Forecast&quot;</span><span class="s2">,</span>
                        <span class="s1">showarrow</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                        <span class="s1">arrowhead</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
                        <span class="s1">ax</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
                        <span class="s1">ay</span><span class="s2">=-</span><span class="s5">40</span><span class="s2">,</span>
                        <span class="s1">font</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">color</span><span class="s2">=</span><span class="s4">'#FF6F61'</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s5">12</span><span class="s2">)</span>
                    <span class="s2">)</span>

                <span class="s3"># Update layout</span>
                <span class="s1">fig</span><span class="s2">.</span><span class="s1">update_layout</span><span class="s2">(</span>
                    <span class="s1">title</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span>
                        <span class="s1">text</span><span class="s2">=</span><span class="s4">f&quot;üìà </span><span class="s0">{</span><span class="s1">selected_product</span><span class="s0">} </span><span class="s4">Unit Sold in </span><span class="s0">{</span><span class="s1">selected_month</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">,</span>
                        <span class="s1">font</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s5">20</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'#2D3F50'</span><span class="s2">),</span>
                        <span class="s1">x</span><span class="s2">=</span><span class="s5">0.03</span><span class="s2">,</span>
                        <span class="s1">y</span><span class="s2">=</span><span class="s5">0.93</span>
                    <span class="s2">),</span>
                    <span class="s1">xaxis</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span>
                        <span class="s1">title</span><span class="s2">=</span><span class="s4">'Year'</span><span class="s2">,</span>
                        <span class="s1">type</span><span class="s2">=</span><span class="s4">'category'</span><span class="s2">,</span>
                        <span class="s1">gridcolor</span><span class="s2">=</span><span class="s4">'rgba(45,63,80,0.1)'</span><span class="s2">,</span>
                        <span class="s1">linecolor</span><span class="s2">=</span><span class="s4">'#2D3F50'</span><span class="s2">,</span>
                        <span class="s1">title_font</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s5">14</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'#2D3F50'</span><span class="s2">),</span>
                        <span class="s1">tickfont</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s5">12</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'#2D3F50'</span><span class="s2">)</span>
                    <span class="s2">),</span>
                    <span class="s1">yaxis</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span>
                        <span class="s1">title</span><span class="s2">=</span><span class="s4">'Units Sold'</span><span class="s2">,</span>
                        <span class="s1">gridcolor</span><span class="s2">=</span><span class="s4">'rgba(45,63,80,0.1)'</span><span class="s2">,</span>
                        <span class="s1">linecolor</span><span class="s2">=</span><span class="s4">'#2D3F50'</span><span class="s2">,</span>
                        <span class="s1">title_font</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s5">14</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'#2D3F50'</span><span class="s2">),</span>
                        <span class="s1">tickfont</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s5">12</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'#2D3F50'</span><span class="s2">),</span>
                        <span class="s1">rangemode</span><span class="s2">=</span><span class="s4">'tozero'</span>
                    <span class="s2">),</span>
                    <span class="s1">plot_bgcolor</span><span class="s2">=</span><span class="s4">'rgba(255,255,255,1)'</span><span class="s2">,</span>
                    <span class="s1">paper_bgcolor</span><span class="s2">=</span><span class="s4">'rgba(245,245,245,1)'</span><span class="s2">,</span>
                    <span class="s1">bargap</span><span class="s2">=</span><span class="s5">0.25</span><span class="s2">,</span>
                    <span class="s1">hoverlabel</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span>
                        <span class="s1">bgcolor</span><span class="s2">=</span><span class="s4">'white'</span><span class="s2">,</span>
                        <span class="s1">font_size</span><span class="s2">=</span><span class="s5">12</span><span class="s2">,</span>
                        <span class="s1">font_family</span><span class="s2">=</span><span class="s4">'Arial'</span><span class="s2">,</span>
                        <span class="s1">font_color</span><span class="s2">=</span><span class="s4">'#2D3F50'</span>
                    <span class="s2">),</span>
                    <span class="s1">legend</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span>
                        <span class="s1">orientation</span><span class="s2">=</span><span class="s4">'h'</span><span class="s2">,</span>
                        <span class="s1">yanchor</span><span class="s2">=</span><span class="s4">'bottom'</span><span class="s2">,</span>
                        <span class="s1">y</span><span class="s2">=</span><span class="s5">1.02</span><span class="s2">,</span>
                        <span class="s1">xanchor</span><span class="s2">=</span><span class="s4">'right'</span><span class="s2">,</span>
                        <span class="s1">x</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
                        <span class="s1">font</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s5">12</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'#2D3F50'</span><span class="s2">)</span>
                    <span class="s2">),</span>
                    <span class="s1">margin</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">l</span><span class="s2">=</span><span class="s5">20</span><span class="s2">, </span><span class="s1">r</span><span class="s2">=</span><span class="s5">20</span><span class="s2">, </span><span class="s1">t</span><span class="s2">=</span><span class="s5">100</span><span class="s2">, </span><span class="s1">b</span><span class="s2">=</span><span class="s5">20</span><span class="s2">),</span>
                    <span class="s1">height</span><span class="s2">=</span><span class="s5">500</span>
                <span class="s2">)</span>

                <span class="s1">st</span><span class="s2">.</span><span class="s1">plotly_chart</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">use_container_width</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">yearly_comparison</span><span class="s2">) &gt;= </span><span class="s5">2</span><span class="s2">:</span>
                    <span class="s0">try</span><span class="s2">:</span>
                        <span class="s3"># Calculate key metrics</span>
                        <span class="s1">max_year </span><span class="s2">= </span><span class="s1">yearly_comparison</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s1">yearly_comparison</span><span class="s2">[</span><span class="s4">'Quantity'</span><span class="s2">].</span><span class="s1">idxmax</span><span class="s2">(), </span><span class="s4">'Year'</span><span class="s2">]</span>
                        <span class="s1">max_sales </span><span class="s2">= </span><span class="s1">yearly_comparison</span><span class="s2">[</span><span class="s4">'Quantity'</span><span class="s2">].</span><span class="s1">max</span><span class="s2">()</span>
                        <span class="s1">min_year </span><span class="s2">= </span><span class="s1">yearly_comparison</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s1">yearly_comparison</span><span class="s2">[</span><span class="s4">'Quantity'</span><span class="s2">].</span><span class="s1">idxmin</span><span class="s2">(), </span><span class="s4">'Year'</span><span class="s2">]</span>
                        <span class="s1">min_sales </span><span class="s2">= </span><span class="s1">yearly_comparison</span><span class="s2">[</span><span class="s4">'Quantity'</span><span class="s2">].</span><span class="s1">min</span><span class="s2">()</span>
                        <span class="s1">latest_sales </span><span class="s2">= </span><span class="s1">yearly_comparison</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">][</span><span class="s4">'Quantity'</span><span class="s2">]</span>
                        <span class="s1">slope </span><span class="s2">= </span><span class="s1">z</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
                        <span class="s1">trend_strength </span><span class="s2">= </span><span class="s4">&quot;strong&quot; </span><span class="s0">if </span><span class="s1">r_squared </span><span class="s2">&gt;= </span><span class="s5">0.7 </span><span class="s0">else </span><span class="s4">&quot;moderate&quot; </span><span class="s0">if </span><span class="s1">r_squared </span><span class="s2">&gt;= </span><span class="s5">0.4 </span><span class="s0">else </span><span class="s4">&quot;weak&quot;</span>
                        <span class="s1">direction </span><span class="s2">= </span><span class="s4">&quot;increasing&quot; </span><span class="s0">if </span><span class="s1">slope </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s4">&quot;decreasing&quot;</span>
                        <span class="s1">annual_change </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">slope</span><span class="s2">)</span>
                        <span class="s1">pct_change </span><span class="s2">= (</span><span class="s1">annual_change </span><span class="s2">/ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)) * </span><span class="s5">100</span>

                        <span class="s1">insights </span><span class="s2">= </span><span class="s4">f&quot;&quot;&quot;</span>
                        <span class="s4">&lt;div style=&quot;padding:15px; background-color:#000000; border-radius:10px; margin-top:20px;&quot;&gt;</span>
                            <span class="s4">&lt;h4 style=&quot;color:white; border-bottom:2px solid #4C78A8; padding-bottom:8px;&quot;&gt;üìå Key Insights (</span><span class="s0">{</span><span class="s1">selected_month</span><span class="s0">} </span><span class="s4">Sales)&lt;/h4&gt;</span>
                            <span class="s4">&lt;ul style=&quot;list-style-type:none; padding-left:0;&quot;&gt;</span>
                                <span class="s4">&lt;li&gt;üìà &lt;strong&gt;Trend Analysis:&lt;/strong&gt; </span><span class="s0">{</span><span class="s1">direction</span><span class="s2">.</span><span class="s1">capitalize</span><span class="s2">()</span><span class="s0">} </span><span class="s4">at </span><span class="s0">{</span><span class="s1">annual_change</span><span class="s0">:</span><span class="s4">.1f</span><span class="s0">} </span><span class="s4">units/year (</span><span class="s0">{</span><span class="s1">pct_change</span><span class="s0">:</span><span class="s4">.1f</span><span class="s0">}</span><span class="s4">% annual change)&lt;/li&gt;</span>
                                <span class="s4">&lt;li&gt;üèÜ &lt;strong&gt;Peak Performance:&lt;/strong&gt; </span><span class="s0">{</span><span class="s1">max_year</span><span class="s0">} </span><span class="s4">recorded highest sales (</span><span class="s0">{</span><span class="s1">max_sales</span><span class="s0">:</span><span class="s4">,</span><span class="s0">} </span><span class="s4">units)&lt;/li&gt;</span>
                                <span class="s4">&lt;li&gt;üìâ &lt;strong&gt;Lowest Sales:&lt;/strong&gt; </span><span class="s0">{</span><span class="s1">min_year</span><span class="s0">} </span><span class="s4">had minimum sales (</span><span class="s0">{</span><span class="s1">min_sales</span><span class="s0">:</span><span class="s4">,</span><span class="s0">} </span><span class="s4">units)&lt;/li&gt;</span>
                                <span class="s4">&lt;li&gt;üîÆ &lt;strong&gt;Recent Performance:&lt;/strong&gt; </span><span class="s0">{</span><span class="s1">yearly_comparison</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">][</span><span class="s4">'Year'</span><span class="s2">]</span><span class="s0">} </span><span class="s4">sales at </span><span class="s0">{</span><span class="s1">latest_sales</span><span class="s0">:</span><span class="s4">,</span><span class="s0">} </span><span class="s4">units&lt;/li&gt;</span>
                            <span class="s4">&lt;/ul&gt;</span>
                            <span class="s4">&lt;p style=&quot;color:white; font-size:0.9em; margin-top:10px;&quot;&gt;</span>
                            <span class="s4">üí° Interpretation: The </span><span class="s0">{</span><span class="s1">trend_strength</span><span class="s0">} {</span><span class="s1">direction</span><span class="s0">} </span><span class="s4">trend suggests </span><span class="s0">{</span>
                        <span class="s4">'growing demand' </span><span class="s0">if </span><span class="s1">direction </span><span class="s2">== </span><span class="s4">'increasing' </span><span class="s0">else</span>
                        <span class="s4">'potential market challenges' </span><span class="s0">if </span><span class="s1">direction </span><span class="s2">== </span><span class="s4">'decreasing' </span><span class="s0">else</span>
                        <span class="s4">'market stability'</span>
                        <span class="s0">} </span><span class="s4">for </span><span class="s0">{</span><span class="s1">selected_product</span><span class="s0">} </span><span class="s4">in </span><span class="s0">{</span><span class="s1">selected_month</span><span class="s0">}</span>
                            <span class="s4">&lt;/p&gt;</span>
                        <span class="s4">&lt;/div&gt;</span>
                        <span class="s4">&quot;&quot;&quot;</span>
                        <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s1">insights</span><span class="s2">, </span><span class="s1">unsafe_allow_html</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
                    <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                        <span class="s1">st</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s4">f&quot;Insights limited: </span><span class="s0">{</span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>

                <span class="s3"># Trend Decomposition Section</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;üìà Trend Decomposition&quot;</span><span class="s2">)</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">time_series </span><span class="s2">= </span><span class="s1">monthly_data</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s4">'Date'</span><span class="s2">)[</span><span class="s4">'Quantity'</span><span class="s2">].</span><span class="s1">sum</span><span class="s2">()</span>
                    <span class="s1">decomposition</span><span class="s2">, </span><span class="s1">insights </span><span class="s2">= </span><span class="s1">perform_trend_decomposition</span><span class="s2">(</span><span class="s1">time_series</span><span class="s2">)</span>

                    <span class="s3"># Combine all components into a single DataFrame for plotting</span>
                    <span class="s1">decomposition_df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span>
                        <span class="s4">'Date'</span><span class="s2">: </span><span class="s1">decomposition</span><span class="s2">.</span><span class="s1">observed</span><span class="s2">.</span><span class="s1">index</span><span class="s2">,</span>
                        <span class="s4">'Observed'</span><span class="s2">: </span><span class="s1">decomposition</span><span class="s2">.</span><span class="s1">observed</span><span class="s2">,</span>
                        <span class="s4">'Trend'</span><span class="s2">: </span><span class="s1">decomposition</span><span class="s2">.</span><span class="s1">trend</span><span class="s2">,</span>
                        <span class="s4">'Seasonal'</span><span class="s2">: </span><span class="s1">decomposition</span><span class="s2">.</span><span class="s1">seasonal</span><span class="s2">,</span>
                        <span class="s4">'Residual'</span><span class="s2">: </span><span class="s1">decomposition</span><span class="s2">.</span><span class="s1">resid</span>
                    <span class="s2">})</span>

                    <span class="s3"># Plot all components in a single graph using Plotly</span>
                    <span class="s1">fig </span><span class="s2">= </span><span class="s1">go</span><span class="s2">.</span><span class="s1">Figure</span><span class="s2">()</span>

                    <span class="s3"># Add observed component</span>
                    <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_trace</span><span class="s2">(</span><span class="s1">go</span><span class="s2">.</span><span class="s1">Scatter</span><span class="s2">(</span>
                        <span class="s1">x</span><span class="s2">=</span><span class="s1">decomposition_df</span><span class="s2">[</span><span class="s4">'Date'</span><span class="s2">],</span>
                        <span class="s1">y</span><span class="s2">=</span><span class="s1">decomposition_df</span><span class="s2">[</span><span class="s4">'Observed'</span><span class="s2">],</span>
                        <span class="s1">mode</span><span class="s2">=</span><span class="s4">'lines'</span><span class="s2">,</span>
                        <span class="s1">name</span><span class="s2">=</span><span class="s4">'Observed'</span><span class="s2">,</span>
                        <span class="s1">line</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">color</span><span class="s2">=</span><span class="s4">'blue'</span><span class="s2">)</span>
                    <span class="s2">))</span>

                    <span class="s3"># Add trend component</span>
                    <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_trace</span><span class="s2">(</span><span class="s1">go</span><span class="s2">.</span><span class="s1">Scatter</span><span class="s2">(</span>
                        <span class="s1">x</span><span class="s2">=</span><span class="s1">decomposition_df</span><span class="s2">[</span><span class="s4">'Date'</span><span class="s2">],</span>
                        <span class="s1">y</span><span class="s2">=</span><span class="s1">decomposition_df</span><span class="s2">[</span><span class="s4">'Trend'</span><span class="s2">],</span>
                        <span class="s1">mode</span><span class="s2">=</span><span class="s4">'lines'</span><span class="s2">,</span>
                        <span class="s1">name</span><span class="s2">=</span><span class="s4">'Trend'</span><span class="s2">,</span>
                        <span class="s1">line</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">color</span><span class="s2">=</span><span class="s4">'green'</span><span class="s2">, </span><span class="s1">dash</span><span class="s2">=</span><span class="s4">'dash'</span><span class="s2">)</span>
                    <span class="s2">))</span>

                    <span class="s3"># Add seasonal component</span>
                    <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_trace</span><span class="s2">(</span><span class="s1">go</span><span class="s2">.</span><span class="s1">Scatter</span><span class="s2">(</span>
                        <span class="s1">x</span><span class="s2">=</span><span class="s1">decomposition_df</span><span class="s2">[</span><span class="s4">'Date'</span><span class="s2">],</span>
                        <span class="s1">y</span><span class="s2">=</span><span class="s1">decomposition_df</span><span class="s2">[</span><span class="s4">'Seasonal'</span><span class="s2">],</span>
                        <span class="s1">mode</span><span class="s2">=</span><span class="s4">'lines'</span><span class="s2">,</span>
                        <span class="s1">name</span><span class="s2">=</span><span class="s4">'Seasonal'</span><span class="s2">,</span>
                        <span class="s1">line</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">color</span><span class="s2">=</span><span class="s4">'orange'</span><span class="s2">, </span><span class="s1">dash</span><span class="s2">=</span><span class="s4">'dot'</span><span class="s2">)</span>
                    <span class="s2">))</span>

                    <span class="s3"># Add residual component</span>
                    <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_trace</span><span class="s2">(</span><span class="s1">go</span><span class="s2">.</span><span class="s1">Scatter</span><span class="s2">(</span>
                        <span class="s1">x</span><span class="s2">=</span><span class="s1">decomposition_df</span><span class="s2">[</span><span class="s4">'Date'</span><span class="s2">],</span>
                        <span class="s1">y</span><span class="s2">=</span><span class="s1">decomposition_df</span><span class="s2">[</span><span class="s4">'Residual'</span><span class="s2">],</span>
                        <span class="s1">mode</span><span class="s2">=</span><span class="s4">'lines'</span><span class="s2">,</span>
                        <span class="s1">name</span><span class="s2">=</span><span class="s4">'Residual'</span><span class="s2">,</span>
                        <span class="s1">line</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">color</span><span class="s2">=</span><span class="s4">'red'</span><span class="s2">, </span><span class="s1">dash</span><span class="s2">=</span><span class="s4">'dash'</span><span class="s2">)</span>
                    <span class="s2">))</span>

                    <span class="s3"># Update layout</span>
                    <span class="s1">fig</span><span class="s2">.</span><span class="s1">update_layout</span><span class="s2">(</span>
                        <span class="s1">title</span><span class="s2">=</span><span class="s4">f&quot;Trend Decomposition for </span><span class="s0">{</span><span class="s1">selected_product</span><span class="s0">} </span><span class="s4">in </span><span class="s0">{</span><span class="s1">selected_month</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">,</span>
                        <span class="s1">xaxis_title</span><span class="s2">=</span><span class="s4">&quot;Date&quot;</span><span class="s2">,</span>
                        <span class="s1">yaxis_title</span><span class="s2">=</span><span class="s4">&quot;Value&quot;</span><span class="s2">,</span>
                        <span class="s1">hovermode</span><span class="s2">=</span><span class="s4">&quot;x unified&quot;</span><span class="s2">,</span>
                        <span class="s1">legend</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">x</span><span class="s2">=</span><span class="s5">0.02</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s5">0.98</span><span class="s2">),</span>
                        <span class="s1">margin</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">l</span><span class="s2">=</span><span class="s5">40</span><span class="s2">, </span><span class="s1">r</span><span class="s2">=</span><span class="s5">40</span><span class="s2">, </span><span class="s1">t</span><span class="s2">=</span><span class="s5">40</span><span class="s2">, </span><span class="s1">b</span><span class="s2">=</span><span class="s5">40</span><span class="s2">)</span>
                    <span class="s2">)</span>

                    <span class="s3"># Display the graph</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">plotly_chart</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">use_container_width</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

                    <span class="s3"># Display insights</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;üîç Decomposition Insights&quot;</span><span class="s2">)</span>

                    <span class="s3"># Create a container for the insights</span>
                    <span class="s0">with </span><span class="s1">st</span><span class="s2">.</span><span class="s1">container</span><span class="s2">():</span>
                        <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">f&quot;&quot;&quot;</span>
                        <span class="s4">&lt;div class='insight-box'&gt;</span>
                            <span class="s4">&lt;h4&gt;üìå Key Insights from Decomposition&lt;/h4&gt;</span>
                            <span class="s4">&lt;ul&gt;</span>
                                <span class="s4">&lt;li&gt;üìÖ &lt;strong&gt;Best Day:&lt;/strong&gt; </span><span class="s0">{</span><span class="s1">insights</span><span class="s2">[</span><span class="s4">'best_day'</span><span class="s2">]</span><span class="s0">}</span><span class="s4">&lt;/li&gt;</span>
                                <span class="s4">&lt;li&gt;üìÖ &lt;strong&gt;Worst Day:&lt;/strong&gt; </span><span class="s0">{</span><span class="s1">insights</span><span class="s2">[</span><span class="s4">'worst_day'</span><span class="s2">]</span><span class="s0">}</span><span class="s4">&lt;/li&gt;</span>
                            <span class="s4">&lt;/ul&gt;</span>
                        <span class="s4">&lt;/div&gt;</span>
                        <span class="s4">&quot;&quot;&quot;</span><span class="s2">, </span><span class="s1">unsafe_allow_html</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

                        <span class="s3"># Yearly comparison using Streamlit's native table</span>
                        <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;üìä Yearly Performance Comparison&quot;</span><span class="s2">)</span>

                        <span class="s3"># Prepare yearly data</span>
                        <span class="s1">yearly_data </span><span class="s2">= []</span>
                        <span class="s0">for </span><span class="s1">year</span><span class="s2">, </span><span class="s1">yearly_insights </span><span class="s0">in </span><span class="s1">insights</span><span class="s2">[</span><span class="s4">'yearly_comparison'</span><span class="s2">].</span><span class="s1">items</span><span class="s2">():</span>
                            <span class="s1">yearly_data</span><span class="s2">.</span><span class="s1">append</span><span class="s2">({</span>
                                <span class="s4">&quot;Year&quot;</span><span class="s2">: </span><span class="s1">year</span><span class="s2">,</span>
                                <span class="s4">&quot;Best Day&quot;</span><span class="s2">: </span><span class="s1">yearly_insights</span><span class="s2">[</span><span class="s4">'best_day'</span><span class="s2">],</span>
                                <span class="s4">&quot;Worst Day&quot;</span><span class="s2">: </span><span class="s1">yearly_insights</span><span class="s2">[</span><span class="s4">'worst_day'</span><span class="s2">],</span>
                                <span class="s4">&quot;Avg Sales&quot;</span><span class="s2">: </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">yearly_insights</span><span class="s2">[</span><span class="s4">'average_sales'</span><span class="s2">]</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">,</span>
                                <span class="s4">&quot;Total Sales&quot;</span><span class="s2">: </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">yearly_insights</span><span class="s2">[</span><span class="s4">'total_sales'</span><span class="s2">]</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">}</span><span class="s4">&quot;</span>
                            <span class="s2">})</span>

                        <span class="s3"># Display as a styled table</span>
                        <span class="s0">if </span><span class="s1">yearly_data</span><span class="s2">:</span>
                            <span class="s1">yearly_df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">yearly_data</span><span class="s2">)</span>
                            <span class="s1">st</span><span class="s2">.</span><span class="s1">dataframe</span><span class="s2">(</span>
                                <span class="s1">yearly_df</span><span class="s2">.</span><span class="s1">style</span>
                                <span class="s2">.</span><span class="s1">set_properties</span><span class="s2">(**{</span>
                                    <span class="s4">'background-color'</span><span class="s2">: </span><span class="s4">'#000000'</span><span class="s2">,</span>
                                    <span class="s4">'color'</span><span class="s2">: </span><span class="s4">'white'</span><span class="s2">,</span>
                                    <span class="s4">'border'</span><span class="s2">: </span><span class="s4">'1px solid #FF6F61'</span>
                                <span class="s2">})</span>
                                <span class="s2">.</span><span class="s1">set_table_styles</span><span class="s2">([{</span>
                                    <span class="s4">'selector'</span><span class="s2">: </span><span class="s4">'th'</span><span class="s2">,</span>
                                    <span class="s4">'props'</span><span class="s2">: [</span>
                                        <span class="s2">(</span><span class="s4">'background-color'</span><span class="s2">, </span><span class="s4">'#FF6F61'</span><span class="s2">),</span>
                                        <span class="s2">(</span><span class="s4">'color'</span><span class="s2">, </span><span class="s4">'white'</span><span class="s2">),</span>
                                        <span class="s2">(</span><span class="s4">'font-weight'</span><span class="s2">, </span><span class="s4">'bold'</span><span class="s2">)</span>
                                    <span class="s2">]</span>
                                <span class="s2">}])</span>
                                <span class="s2">.</span><span class="s1">hide</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">'index'</span><span class="s2">),</span>
                                <span class="s1">height</span><span class="s2">=(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">yearly_df</span><span class="s2">) * </span><span class="s5">35</span><span class="s2">) + </span><span class="s5">38</span><span class="s2">,</span>
                                <span class="s1">use_container_width</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                                <span class="s1">hide_index</span><span class="s2">=</span><span class="s0">True</span>
                            <span class="s2">)</span>
                        <span class="s0">else</span><span class="s2">:</span>
                            <span class="s1">st</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s4">&quot;No yearly comparison data available&quot;</span><span class="s2">)</span>
                <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s4">f&quot;Trend decomposition error: </span><span class="s0">{</span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s4">f&quot;Analysis error: </span><span class="s0">{</span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s4">&quot;‚ÑπÔ∏è Please select a product from the sidebar to view analysis&quot;</span><span class="s2">)</span>

<span class="s3"># Tab 2: Product Associations</span>
<span class="s0">with </span><span class="s1">tab2</span><span class="s2">:</span>
    <span class="s1">st</span><span class="s2">.</span><span class="s1">header</span><span class="s2">(</span><span class="s4">&quot;üîó Product Association Analysis&quot;</span><span class="s2">)</span>
    <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;Discover which products are frequently purchased together to optimize bundling and placement.&quot;</span><span class="s2">)</span>

    <span class="s3"># Date range selector</span>
    <span class="s1">assoc_date_range </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">date_input</span><span class="s2">(</span><span class="s4">&quot;üìÜ Select Date Range for Analysis&quot;</span><span class="s2">, [</span><span class="s1">min_date</span><span class="s2">, </span><span class="s1">max_date</span><span class="s2">])</span>

    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">assoc_date_range</span><span class="s2">) == </span><span class="s5">2</span><span class="s2">:</span>
        <span class="s1">assoc_start</span><span class="s2">, </span><span class="s1">assoc_end </span><span class="s2">= [</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s1">date</span><span class="s2">) </span><span class="s0">for </span><span class="s1">date </span><span class="s0">in </span><span class="s1">assoc_date_range</span><span class="s2">]</span>
        <span class="s1">assoc_data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[(</span><span class="s1">data</span><span class="s2">[</span><span class="s4">'Date'</span><span class="s2">] &gt;= </span><span class="s1">assoc_start</span><span class="s2">) &amp; (</span><span class="s1">data</span><span class="s2">[</span><span class="s4">'Date'</span><span class="s2">] &lt;= </span><span class="s1">assoc_end</span><span class="s2">)]</span>

        <span class="s0">if not </span><span class="s1">assoc_data</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">:</span>
            <span class="s3"># Parameter controls</span>
            <span class="s1">col1</span><span class="s2">, </span><span class="s1">col2 </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">col1</span><span class="s2">:</span>
                <span class="s1">min_support </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">slider</span><span class="s2">(</span><span class="s4">&quot;üìå Minimum Support&quot;</span><span class="s2">, </span><span class="s5">0.001</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.01</span><span class="s2">, </span><span class="s5">0.001</span><span class="s2">,</span>
                                        <span class="s1">help</span><span class="s2">=</span><span class="s4">&quot;Minimum frequency of items appearing together&quot;</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">col2</span><span class="s2">:</span>
                <span class="s1">min_lift </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">slider</span><span class="s2">(</span><span class="s4">&quot;üîó Minimum Lift&quot;</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">10.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">,</span>
                                     <span class="s1">help</span><span class="s2">=</span><span class="s4">&quot;Minimum strength of association between items&quot;</span><span class="s2">)</span>

            <span class="s3"># Prepare transaction data</span>
            <span class="s1">transactions </span><span class="s2">= </span><span class="s1">assoc_data</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s4">'ticket_number'</span><span class="s2">)[</span><span class="s4">'Item'</span><span class="s2">].</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">list</span><span class="s2">).</span><span class="s1">tolist</span><span class="s2">()</span>

            <span class="s3"># One-hot encode transactions</span>
            <span class="s1">te </span><span class="s2">= </span><span class="s1">TransactionEncoder</span><span class="s2">()</span>
            <span class="s1">te_ary </span><span class="s2">= </span><span class="s1">te</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">transactions</span><span class="s2">).</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">transactions</span><span class="s2">)</span>
            <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">te_ary</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">te</span><span class="s2">.</span><span class="s1">columns_</span><span class="s2">)</span>

            <span class="s3"># Get frequent itemsets</span>
            <span class="s1">frequent_itemsets </span><span class="s2">= </span><span class="s1">fpgrowth</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">min_support</span><span class="s2">=</span><span class="s1">min_support</span><span class="s2">, </span><span class="s1">use_colnames</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

            <span class="s0">if not </span><span class="s1">frequent_itemsets</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">:</span>
                <span class="s3"># Generate association rules</span>
                <span class="s1">rules </span><span class="s2">= </span><span class="s1">association_rules</span><span class="s2">(</span><span class="s1">frequent_itemsets</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s4">&quot;lift&quot;</span><span class="s2">, </span><span class="s1">min_threshold</span><span class="s2">=</span><span class="s1">min_lift</span><span class="s2">)</span>

                <span class="s0">if not </span><span class="s1">rules</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">:</span>
                    <span class="s3"># Convert frozensets to strings for display</span>
                    <span class="s1">rules</span><span class="s2">[</span><span class="s4">'antecedents'</span><span class="s2">] = </span><span class="s1">rules</span><span class="s2">[</span><span class="s4">'antecedents'</span><span class="s2">].</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s4">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)))</span>
                    <span class="s1">rules</span><span class="s2">[</span><span class="s4">'consequents'</span><span class="s2">] = </span><span class="s1">rules</span><span class="s2">[</span><span class="s4">'consequents'</span><span class="s2">].</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s4">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)))</span>

                    <span class="s3"># Show top rules</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;üìã Top Association Rules&quot;</span><span class="s2">)</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">dataframe</span><span class="s2">(</span>
                        <span class="s1">rules</span><span class="s2">.</span><span class="s1">sort_values</span><span class="s2">(</span><span class="s4">'lift'</span><span class="s2">, </span><span class="s1">ascending</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">head</span><span class="s2">(</span><span class="s5">10</span><span class="s2">).</span><span class="s1">reset_index</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s0">True</span><span class="s2">),</span>
                        <span class="s1">height</span><span class="s2">=</span><span class="s5">400</span>
                    <span class="s2">)</span>

                    <span class="s3"># Parallel categories plot</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;üîÑ Product Association Network&quot;</span><span class="s2">)</span>
                    <span class="s1">fig </span><span class="s2">= </span><span class="s1">px</span><span class="s2">.</span><span class="s1">parallel_categories</span><span class="s2">(</span>
                        <span class="s1">rules</span><span class="s2">.</span><span class="s1">head</span><span class="s2">(</span><span class="s5">20</span><span class="s2">),</span>
                        <span class="s1">dimensions</span><span class="s2">=[</span><span class="s4">'antecedents'</span><span class="s2">, </span><span class="s4">'consequents'</span><span class="s2">],</span>
                        <span class="s1">color</span><span class="s2">=</span><span class="s4">'lift'</span><span class="s2">,</span>
                        <span class="s1">color_continuous_scale</span><span class="s2">=</span><span class="s1">px</span><span class="s2">.</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">sequential</span><span class="s2">.</span><span class="s1">Inferno</span><span class="s2">,</span>
                        <span class="s1">labels</span><span class="s2">={</span>
                            <span class="s4">'antecedents'</span><span class="s2">: </span><span class="s4">'Products Bought'</span><span class="s2">,</span>
                            <span class="s4">'consequents'</span><span class="s2">: </span><span class="s4">'Often Bought With'</span><span class="s2">,</span>
                            <span class="s4">'lift'</span><span class="s2">: </span><span class="s4">'Association Strength'</span>
                        <span class="s2">},</span>
                        <span class="s1">height</span><span class="s2">=</span><span class="s5">600</span>
                    <span class="s2">)</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">plotly_chart</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">use_container_width</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

                    <span class="s3"># Item pair frequency table</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;üìä Frequently Bought Together&quot;</span><span class="s2">)</span>

                    <span class="s3"># Get all item pairs from transactions</span>
                    <span class="s1">pair_counts </span><span class="s2">= {}</span>
                    <span class="s0">for </span><span class="s1">transaction </span><span class="s0">in </span><span class="s1">transactions</span><span class="s2">:</span>
                        <span class="s1">items </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">transaction</span><span class="s2">))  </span><span class="s3"># Remove duplicates within a transaction</span>
                        <span class="s0">for </span><span class="s1">pair </span><span class="s0">in </span><span class="s1">combinations</span><span class="s2">(</span><span class="s1">items</span><span class="s2">, </span><span class="s5">2</span><span class="s2">):</span>
                            <span class="s1">sorted_pair </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">pair</span><span class="s2">))</span>
                            <span class="s1">pair_counts</span><span class="s2">[</span><span class="s1">sorted_pair</span><span class="s2">] = </span><span class="s1">pair_counts</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">sorted_pair</span><span class="s2">, </span><span class="s5">0</span><span class="s2">) + </span><span class="s5">1</span>

                    <span class="s3"># Convert to DataFrame</span>
                    <span class="s1">pair_df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
                        <span class="s2">[(</span><span class="s4">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">pair</span><span class="s2">), </span><span class="s1">count</span><span class="s2">) </span><span class="s0">for </span><span class="s1">pair</span><span class="s2">, </span><span class="s1">count </span><span class="s0">in </span><span class="s1">pair_counts</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()],</span>
                        <span class="s1">columns</span><span class="s2">=[</span><span class="s4">'Item Pair'</span><span class="s2">, </span><span class="s4">'Count'</span><span class="s2">]</span>
                    <span class="s2">).</span><span class="s1">sort_values</span><span class="s2">(</span><span class="s4">'Count'</span><span class="s2">, </span><span class="s1">ascending</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

                    <span class="s1">st</span><span class="s2">.</span><span class="s1">dataframe</span><span class="s2">(</span>
                        <span class="s1">pair_df</span><span class="s2">.</span><span class="s1">head</span><span class="s2">(</span><span class="s5">20</span><span class="s2">).</span><span class="s1">reset_index</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s0">True</span><span class="s2">),</span>
                        <span class="s1">height</span><span class="s2">=</span><span class="s5">400</span>
                    <span class="s2">)</span>

                    <span class="s3"># Generate insights</span>
                    <span class="s1">strongest_rule </span><span class="s2">= </span><span class="s1">rules</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
                    <span class="s1">insight_text </span><span class="s2">= </span><span class="s4">f&quot;&quot;&quot;</span>
                        <span class="s4">&lt;div class='insight-box'&gt;</span>
                            <span class="s4">&lt;h4&gt;üí° Association Insights&lt;/h4&gt;</span>
                            <span class="s4">&lt;ul&gt;</span>
                                <span class="s4">&lt;li&gt;When customers buy &lt;strong&gt;</span><span class="s0">{</span><span class="s1">strongest_rule</span><span class="s2">[</span><span class="s4">'antecedents'</span><span class="s2">]</span><span class="s0">}</span><span class="s4">&lt;/strong&gt;, </span>
                                <span class="s4">they're &lt;strong&gt;</span><span class="s0">{</span><span class="s1">strongest_rule</span><span class="s2">[</span><span class="s4">'confidence'</span><span class="s2">] * </span><span class="s5">100</span><span class="s0">:</span><span class="s4">.1f</span><span class="s0">}</span><span class="s4">%&lt;/strong&gt; likely to also buy </span>
                                <span class="s4">&lt;strong&gt;</span><span class="s0">{</span><span class="s1">strongest_rule</span><span class="s2">[</span><span class="s4">'consequents'</span><span class="s2">]</span><span class="s0">}</span><span class="s4">&lt;/strong&gt;&lt;/li&gt;</span>
                                <span class="s4">&lt;li&gt;This combination occurs in &lt;strong&gt;</span><span class="s0">{</span><span class="s1">strongest_rule</span><span class="s2">[</span><span class="s4">'support'</span><span class="s2">] * </span><span class="s5">100</span><span class="s0">:</span><span class="s4">.1f</span><span class="s0">}</span><span class="s4">%&lt;/strong&gt; of transactions&lt;/li&gt;</span>
                                <span class="s4">&lt;li&gt;The lift value of &lt;strong&gt;</span><span class="s0">{</span><span class="s1">strongest_rule</span><span class="s2">[</span><span class="s4">'lift'</span><span class="s2">]</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">}</span><span class="s4">&lt;/strong&gt; indicates a strong association&lt;/li&gt;</span>
                            <span class="s4">&lt;/ul&gt;</span>
                            <span class="s4">&lt;p&gt;Consider bundling these items or placing them near each other to increase sales!&lt;/p&gt;</span>
                        <span class="s4">&lt;/div&gt;</span>
                    <span class="s4">&quot;&quot;&quot;</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s1">insight_text</span><span class="s2">, </span><span class="s1">unsafe_allow_html</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s4">&quot;No significant association rules found. Try adjusting the support or lift thresholds.&quot;</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s4">&quot;No frequent itemsets found. Try adjusting the minimum support threshold.&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s4">&quot;No data available for the selected date range&quot;</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s4">&quot;Please select a valid date range for analysis&quot;</span><span class="s2">)</span></pre>
</body>
</html>